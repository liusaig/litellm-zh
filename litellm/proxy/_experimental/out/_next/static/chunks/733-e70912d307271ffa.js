"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[733],{21088:(e,s,t)=>{t.d(s,{Es:()=>a.A,Zp:()=>l.A,hE:()=>r.A});var a=t(85263),l=t(42837),r=t(64628)},32826:(e,s,t)=>{t.d(s,{_:()=>o});var a=t(28436),l=t(26708),r=t(90078),i=t(90550),n=t(42696);let c=(0,r.D)("agents"),o=()=>{let{accessToken:e,userRole:s}=(0,n.A)();return(0,l.I)({queryKey:c.list({}),queryFn:async()=>await (0,a.getAgentsList)(e),enabled:!!e&&i.CX.includes(s||"")})}},34844:(e,s,t)=>{t.d(s,{A:()=>c});var a=t(95155),l=t(12115),r=t(28436),i=t(88534),n=t(42696);let c=({userSpend:e,userMaxBudget:s,selectedTeam:t})=>{let{accessToken:c,userRole:o,userId:d}=(0,n.A)(),[u,m]=(0,l.useState)(null!==e?e:0),[x,p]=(0,l.useState)(t?Number((0,i.HY)(t.max_budget,4)):null);(0,l.useEffect)(()=>{if(t)if("Default Team"===t.team_alias)p(s);else{let e=!1;if(t.team_memberships)for(let s of t.team_memberships)s.user_id===d&&"max_budget"in s.litellm_budget_table&&null!==s.litellm_budget_table.max_budget&&(p(s.litellm_budget_table.max_budget),e=!0);e||p(t.max_budget)}else p(s)},[t,s]);let[h,g]=(0,l.useState)([]);(0,l.useEffect)(()=>{let e=async()=>{if(!c||!d||!o)return};(async()=>{try{if(null===d||null===o)return;if(null!==c){let e=(await (0,r.modelAvailableCall)(c,d,o)).data.map(e=>e.id);console.log("available_model_names:",e),g(e)}}catch(e){console.error("Error fetching user models:",e)}})(),e()},[o,c,d]),(0,l.useEffect)(()=>{null!==e&&m(e)},[e]);let _=[];t&&t.models&&(_=t.models),_&&_.includes("all-proxy-models")?(console.log("user models:",h),_=h):_&&_.includes("all-team-models")?_=t.models:_&&0===_.length&&(_=h);let j=null!==x?`\xa5${(0,i.HY)(Number(x),4)}`:"不限制",f=void 0!==u?(0,i.HY)(u,4):null,y=null===x?"无限":`\xa5${(0,i.HY)(Number(x)-Number(u||0),4)}`;return console.log(`spend in view user spend: ${u}`),(0,a.jsx)("div",{className:"flex items-center",children:(0,a.jsxs)("div",{className:"flex justify-between gap-x-10",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("p",{className:"text-xs text-slate-500 font-medium tracking-wide",children:"总花费"}),(0,a.jsxs)("p",{className:"text-[26px] md:text-[30px] text-slate-900 font-semibold leading-tight mt-1.5",children:["\xa5",f]})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("p",{className:"text-xs text-slate-500 font-medium tracking-wide",children:"最大预算"}),(0,a.jsx)("p",{className:"text-[26px] md:text-[30px] text-slate-900 font-semibold leading-tight mt-1.5",children:j})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("p",{className:"text-xs text-slate-500 font-medium tracking-wide",children:"余额"}),(0,a.jsx)("p",{className:"text-[26px] md:text-[30px] text-slate-900 font-semibold leading-tight mt-1.5",children:y})]})]})})}},55445:(e,s,t)=>{t.d(s,{A:()=>_});var a=t(95155),l=t(42696),r=t(14992),i=t(17293),n=t(85263),c=t(38983),o=t(22277),d=t(3840),u=t(12115),m=t(14290),x=t(88534),p=t(28436),h=t(98086),g=t(53672);let _=({topKeys:e,teams:s,showTags:t=!1,topKeysLimit:_,setTopKeysLimit:j})=>{let{accessToken:f,userRole:y,userId:k,premiumUser:b}=(0,l.A)(),{t:A}=(0,m.o)(),[v,N]=(0,u.useState)(!1),[w,q]=(0,u.useState)(null),[S,C]=(0,u.useState)(void 0),[P,T]=(0,u.useState)("table"),[D,E]=(0,u.useState)(new Set),L=async e=>{if(f)try{let s=await (0,p.keyInfoV1Call)(f,e.api_key),t=(e=>{let{key:s,info:t}=e;return{token:s,...t}})(s);C(t),q(e.api_key),N(!0)}catch(e){console.error("Error fetching key info:",e)}},M=()=>{N(!1),q(null),C(void 0)};u.useEffect(()=>{let e=e=>{"Escape"===e.key&&v&&M()};return document.addEventListener("keydown",e),()=>document.removeEventListener("keydown",e)},[v]);let O=[{header:A("usagePage.topKeyView.keyId"),accessorKey:"api_key",cell:e=>(0,a.jsx)("div",{className:"overflow-hidden",children:(0,a.jsx)(o.A,{title:e.getValue(),children:(0,a.jsx)(c.A,{size:"xs",variant:"light",className:"font-mono text-blue-500 bg-blue-50 hover:bg-blue-100 text-xs font-normal px-2 py-0.5 text-left overflow-hidden truncate max-w-[200px]",onClick:()=>L(e.row.original),children:e.getValue()?`${e.getValue().slice(0,7)}...`:"-"})})})},{header:A("usagePage.topKeyView.keyAlias"),accessorKey:"key_alias",cell:e=>e.getValue()||"-"}],U={header:A("usagePage.topKeyView.tags"),accessorKey:"tags",cell:e=>{let s=e.getValue(),t=e.row.original.api_key,l=D.has(t);if(!s||0===s.length)return"-";let n=s.sort((e,s)=>s.usage-e.usage),c=l?n:n.slice(0,2),d=s.length>2;return(0,a.jsx)("div",{className:"overflow-hidden",children:(0,a.jsxs)("div",{className:"flex flex-wrap items-center gap-1",children:[c.map((e,s)=>(0,a.jsx)(o.A,{title:(0,a.jsxs)("div",{children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("span",{className:"text-gray-300",children:"Tag Name:"})," ",e.tag]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("span",{className:"text-gray-300",children:"Spend:"})," ",e.usage>0&&e.usage<.01?"<\xa50.01":`\xa5${(0,x.HY)(e.usage,2)}`]})]}),children:(0,a.jsxs)("span",{className:"px-2 py-1 bg-gray-100 rounded-full text-xs",children:[e.tag.slice(0,7),"..."]})},s)),d&&(0,a.jsx)("button",{onClick:()=>{E(e=>{let s=new Set(e);return s.has(t)?s.delete(t):s.add(t),s})},className:"ml-1 p-1 hover:bg-gray-200 rounded-full transition-colors",title:l?A("usagePage.topKeyView.showFewerTags"):A("usagePage.topKeyView.showAllTags"),children:l?(0,a.jsx)(r.A,{className:"h-3 w-3 text-gray-500"}):(0,a.jsx)(i.A,{className:"h-3 w-3 text-gray-500"})})]})})}},F={header:A("usagePage.topKeyView.spend"),accessorKey:"spend",cell:e=>{let s=e.getValue();return s>0&&s<.01?"<\xa50.01":`\xa5${(0,x.HY)(s,2)}`}},$=t?[...O,U,F]:[...O,F],R=e.map(e=>({...e,display_key_alias:e.key_alias&&e.key_alias.length>10?`${e.key_alias.slice(0,10)}...`:e.key_alias||"-"}));return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)("div",{className:"mb-4 flex justify-between items-center",children:[(0,a.jsx)(d.A,{options:[{label:"5",value:5},{label:"10",value:10},{label:"25",value:25},{label:"50",value:50}],value:_,onChange:e=>j(e)}),(0,a.jsxs)("div",{className:"flex space-x-2",children:[(0,a.jsx)("button",{onClick:()=>T("table"),className:`px-3 py-1 text-sm rounded-md ${"table"===P?"bg-blue-100 text-blue-700":"bg-gray-100 text-gray-700"}`,children:A("usagePage.topKeyView.tableView")}),(0,a.jsx)("button",{onClick:()=>T("chart"),className:`px-3 py-1 text-sm rounded-md ${"chart"===P?"bg-blue-100 text-blue-700":"bg-gray-100 text-gray-700"}`,children:A("图表视图")})]})]}),"chart"===P?(0,a.jsx)("div",{className:"relative max-h-[600px] overflow-y-auto",children:(0,a.jsx)(n.A,{className:"mt-4 cursor-pointer hover:opacity-90",style:{height:52*Math.min(R.length,_)},data:R,index:"display_key_alias",categories:["spend"],colors:["cyan"],yAxisWidth:120,tickGap:5,layout:"vertical",showLegend:!1,valueFormatter:e=>`\xa5${(0,x.HY)(e)}`,onValueChange:e=>L(e),showTooltip:!0,customTooltip:e=>{let s=e.payload?.[0]?.payload;return(0,a.jsx)("div",{className:"relative z-50 p-3 bg-black/90 shadow-lg rounded-lg text-white max-w-xs",children:(0,a.jsxs)("div",{className:"space-y-1.5",children:[(0,a.jsxs)("div",{className:"text-sm",children:[(0,a.jsx)("span",{className:"text-gray-300",children:"Key Alias: "}),(0,a.jsx)("span",{className:"font-mono text-gray-100 break-all",children:s?.key_alias})]}),(0,a.jsxs)("div",{className:"text-sm",children:[(0,a.jsx)("span",{className:"text-gray-300",children:"Key ID: "}),(0,a.jsx)("span",{className:"font-mono text-gray-100 break-all",children:s?.api_key})]}),(0,a.jsxs)("div",{className:"text-sm",children:[(0,a.jsx)("span",{className:"text-gray-300",children:"Spend: "}),(0,a.jsxs)("span",{className:"text-white font-medium",children:["$",(0,x.HY)(s?.spend,2)]})]})]})})}})}):(0,a.jsx)("div",{className:"border rounded-lg overflow-hidden max-h-[600px] overflow-y-auto",children:(0,a.jsx)(g.b,{columns:$,data:e,renderSubComponent:()=>(0,a.jsx)(a.Fragment,{}),getRowCanExpand:()=>!1,isLoading:!1})}),v&&w&&S&&(console.log("Rendering modal with:",{isModalOpen:v,selectedKey:w,keyData:S}),(0,a.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",onClick:e=>{e.target===e.currentTarget&&M()},children:(0,a.jsxs)("div",{className:"bg-white rounded-lg shadow-xl relative w-11/12 max-w-6xl max-h-[90vh] overflow-y-auto min-h-[750px]",children:[(0,a.jsx)("button",{onClick:M,className:"absolute top-4 right-4 text-gray-500 hover:text-gray-700 focus:outline-none","aria-label":"Close",children:(0,a.jsx)("svg",{className:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M6 18L18 6M6 6l12 12"})})}),(0,a.jsx)("div",{className:"p-6 h-full",children:(0,a.jsx)(h.A,{keyId:w,onClose:M,keyData:S,teams:s})})]})}))]})}},80733:(e,s,t)=>{t.d(s,{A:()=>s_});var a=t(95155),l=t(24805),r=t(34568),i=t(94300),n=t(85263),c=t(42837),o=t(27309),d=t(13121),u=t(2212),m=t(87927),x=t(56680),p=t(73806),h=t(79363),g=t(75892),_=t(64628),j=t(23060),f=t(22277),y=t(3840),k=t(99876),b=t(41326),A=t(5433),v=t(27866),N=t.n(v),w=t(12115),q=t(14290),S=t(32826),C=t(28436),P=t(26708),T=t(90078),D=t(90550),E=t(42696);let L=(0,T.D)("customers");var M=t(98336),O=t(25366);let U=(0,T.D)("infiniteUsers"),F=50;var $=t(88534),R=t(67667),z=t(84649),I=t(73289),V=t(10639);let K={blue:"#3b82f6",cyan:"#06b6d4",indigo:"#6366f1",green:"#22c55e",red:"#ef4444",purple:"#8b5cf6",emerald:"#37bc7d"},Y=({active:e,payload:s,label:t})=>{let{locale:l}=(0,q.o)(),r="zh-CN"===l;if(e&&s&&s.length){let e=e=>e.replace("metrics.","").replace(/_/g," ").split(" ").map(e=>e.charAt(0).toUpperCase()+e.slice(1)).join(" ");return(0,a.jsxs)("div",{className:"w-56 rounded-tremor-default border border-tremor-border bg-tremor-background p-2 text-tremor-default shadow-tremor-dropdown",children:[(0,a.jsx)("p",{className:"text-tremor-content-strong",children:t}),s.map(s=>{let t,l=s.dataKey?.toString();if(!l||!s.payload)return null;let i=((e,s)=>{let t=s.substring(s.indexOf(".")+1);if(e.metrics&&t in e.metrics)return e.metrics[t]})(s.payload,l),n=l.includes("spend"),c=void 0!==i?n?`\xa5${i.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})}`:i.toLocaleString():"N/A",o=K[s.color]||s.color;return(0,a.jsxs)("div",{className:"flex items-center justify-between space-x-4",children:[(0,a.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,a.jsx)("span",{className:"h-2 w-2 shrink-0 rounded-full ring-2 ring-white drop-shadow-md",style:{backgroundColor:o}}),(0,a.jsx)("p",{className:"font-medium text-tremor-content dark:text-dark-tremor-content",children:(t=l.replace("metrics.",""),r&&({successful_requests:"成功请求数",failed_requests:"失败请求数",total_tokens:"总 Token 数",prompt_tokens:"输入 Token 数",completion_tokens:"输出 Token 数",api_requests:"总请求数",spend:"花费",cache_read_input_tokens:"缓存读取输入 Token",cache_creation_input_tokens:"缓存创建输入 Token"})[t]||e(l))})]}),(0,a.jsx)("p",{className:"font-medium text-tremor-content-emphasis dark:text-dark-tremor-content-emphasis",children:c})]},l)})]})}return null},H=({categories:e,colors:s})=>{let{locale:t}=(0,q.o)(),l="zh-CN"===t,r=e=>e.replace("metrics.","").replace(/_/g," ").split(" ").map(e=>e.charAt(0).toUpperCase()+e.slice(1)).join(" ");return(0,a.jsx)("div",{className:"flex items-center justify-end space-x-4",children:e.map((e,t)=>{let i,n=K[s[t]]||s[t];return(0,a.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,a.jsx)("span",{className:"h-2 w-2 shrink-0 rounded-full ring-4 ring-white",style:{backgroundColor:n}}),(0,a.jsx)("p",{className:"text-sm text-tremor-content dark:text-dark-tremor-content",children:(i=e.replace("metrics.",""),l&&({successful_requests:"成功请求数",failed_requests:"失败请求数",total_tokens:"总 Token 数",prompt_tokens:"输入 Token 数",completion_tokens:"输出 Token 数",api_requests:"总请求数",spend:"花费",cache_read_input_tokens:"缓存读取输入 Token",cache_creation_input_tokens:"缓存创建输入 Token"})[i]||r(e))})]},e)})})};var B=t(21088),W=t(50139);let Z=({topModels:e})=>{let{t:s}=(0,q.o)(),[t,l]=(0,w.useState)("table"),r=(0,w.useMemo)(()=>[{title:s("usagePage.keyModelUsage.model"),dataIndex:"model",key:"model",render:e=>e||"-"},{title:s("usagePage.keyModelUsage.spend"),dataIndex:"spend",key:"spend",render:e=>`\xa5${(0,$.HY)(e)}`},{title:s("usagePage.keyModelUsage.successful"),dataIndex:"successful_requests",key:"successful_requests",render:e=>(0,a.jsx)("span",{className:"text-green-600",children:e?.toLocaleString()||0})},{title:s("usagePage.keyModelUsage.failed"),dataIndex:"failed_requests",key:"failed_requests",render:e=>(0,a.jsx)("span",{className:"text-red-600",children:e?.toLocaleString()||0})},{title:s("usagePage.keyModelUsage.tokens"),dataIndex:"tokens",key:"tokens",render:e=>e?.toLocaleString()||0}],[s]);return 0===e.length?null:(0,a.jsxs)(B.Zp,{className:"mt-4",children:[(0,a.jsxs)("div",{className:"flex justify-between items-center mb-3",children:[(0,a.jsx)(B.hE,{children:s("usagePage.keyModelUsage.title")}),(0,a.jsxs)("div",{className:"flex space-x-2",children:[(0,a.jsx)("button",{onClick:()=>l("table"),className:`px-3 py-1 text-sm rounded-md ${"table"===t?"bg-blue-100 text-blue-700":"bg-gray-100 text-gray-700"}`,children:s("usagePage.keyModelUsage.table")}),(0,a.jsx)("button",{onClick:()=>l("chart"),className:`px-3 py-1 text-sm rounded-md ${"chart"===t?"bg-blue-100 text-blue-700":"bg-gray-100 text-gray-700"}`,children:s("usagePage.keyModelUsage.chart")})]})]}),"chart"===t?(0,a.jsx)("div",{className:"max-h-[234px] overflow-y-auto",children:(0,a.jsx)(B.Es,{style:{height:40*e.length},data:e.map(e=>({key:e.model,spend:e.spend})),index:"key",categories:["spend"],colors:["cyan"],valueFormatter:e=>`\xa5${(0,$.HY)(e)}`,layout:"vertical",yAxisWidth:180,tickGap:5,showLegend:!1})}):(0,a.jsx)(W.A,{columns:r,dataSource:e,rowKey:"model",size:"small",pagination:!1,scroll:e.length>5?{y:195}:void 0})]})};function G(e){return e>=1e6?(e/1e6).toFixed(2)+"M":e>=1e3?e/1e3+"k":e.toString()}function J(e){return 0===e?"\xa50":e>=1e6?"\xa5"+e/1e6+"M":e>=1e3?"\xa5"+e/1e3+"k":"\xa5"+e}let X=({modelName:e,metrics:s,labels:t,hidePromptCachingMetrics:l=!1})=>(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsxs)(d.A,{numItems:4,className:"gap-4",children:[(0,a.jsxs)(c.A,{children:[(0,a.jsx)(g.A,{children:t.totalRequests}),(0,a.jsx)(_.A,{children:s.total_requests.toLocaleString()})]}),(0,a.jsxs)(c.A,{children:[(0,a.jsx)(g.A,{children:t.totalSuccessfulRequests}),(0,a.jsx)(_.A,{children:s.total_successful_requests.toLocaleString()})]}),(0,a.jsxs)(c.A,{children:[(0,a.jsx)(g.A,{children:t.totalTokens}),(0,a.jsx)(_.A,{children:s.total_tokens.toLocaleString()}),(0,a.jsxs)(g.A,{children:[Math.round(s.total_tokens/s.total_successful_requests)," ",t.avgPerSuccessfulRequest]})]}),(0,a.jsxs)(c.A,{children:[(0,a.jsx)(g.A,{children:t.totalSpend}),(0,a.jsxs)(_.A,{children:["\xa5",(0,$.HY)(s.total_spend,2)]}),(0,a.jsxs)(g.A,{children:["\xa5",(0,$.HY)(s.total_spend/s.total_successful_requests,3)," ",t.perSuccessfulRequest]})]})]}),s.top_api_keys&&s.top_api_keys.length>0&&(0,a.jsxs)(c.A,{className:"mt-4",children:[(0,a.jsx)(_.A,{children:t.topApiKeysBySpend}),(0,a.jsx)("div",{className:"mt-3",children:(0,a.jsx)("div",{className:"grid grid-cols-1 gap-2",children:s.top_api_keys.map((e,s)=>(0,a.jsxs)("div",{className:"flex justify-between items-center p-3 bg-gray-50 rounded-lg",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)(g.A,{className:"font-medium",children:e.key_alias||`${e.api_key.substring(0,10)}...`}),e.team_id&&(0,a.jsxs)(g.A,{className:"text-xs text-gray-500",children:[t.team,": ",e.team_id]})]}),(0,a.jsxs)("div",{className:"text-right",children:[(0,a.jsxs)(g.A,{className:"font-medium",children:["\xa5",(0,$.HY)(e.spend,2)]}),(0,a.jsxs)(g.A,{className:"text-xs text-gray-500",children:[e.requests.toLocaleString()," ",t.requests," | ",e.tokens.toLocaleString()," ",t.tokens]})]})]},e.api_key))})})]}),s.top_models&&s.top_models.length>0&&(0,a.jsx)(Z,{topModels:s.top_models}),(0,a.jsxs)(c.A,{className:"mt-4",children:[(0,a.jsxs)("div",{className:"flex justify-between items-center",children:[(0,a.jsx)(_.A,{children:t.spendPerDay}),(0,a.jsx)(H,{categories:["metrics.spend"],colors:["green"]})]}),(0,a.jsx)(n.A,{className:"mt-4",data:s.daily_data,index:"date",categories:["metrics.spend"],colors:["green"],valueFormatter:e=>`\xa5${(0,$.HY)(e)}`,yAxisWidth:72})]}),(0,a.jsxs)(d.A,{numItems:2,className:"gap-4 mt-4",children:[(0,a.jsxs)(c.A,{children:[(0,a.jsxs)("div",{className:"flex justify-between items-center",children:[(0,a.jsx)(_.A,{children:t.totalTokens}),(0,a.jsx)(H,{categories:["metrics.prompt_tokens","metrics.completion_tokens","metrics.total_tokens"],colors:["blue","cyan","indigo"]})]}),(0,a.jsx)(I.A,{className:"mt-4",data:s.daily_data,index:"date",categories:["metrics.prompt_tokens","metrics.completion_tokens","metrics.total_tokens"],colors:["blue","cyan","indigo"],valueFormatter:G,customTooltip:Y,showLegend:!1})]}),(0,a.jsxs)(c.A,{children:[(0,a.jsxs)("div",{className:"flex justify-between items-center",children:[(0,a.jsx)(_.A,{children:t.requestsPerDay}),(0,a.jsx)(H,{categories:["metrics.api_requests"],colors:["blue"]})]}),(0,a.jsx)(n.A,{className:"mt-4",data:s.daily_data,index:"date",categories:["metrics.api_requests"],colors:["blue"],valueFormatter:G,customTooltip:Y,showLegend:!1})]}),(0,a.jsxs)(c.A,{children:[(0,a.jsxs)("div",{className:"flex justify-between items-center",children:[(0,a.jsx)(_.A,{children:t.successVsFailedRequests}),(0,a.jsx)(H,{categories:["metrics.successful_requests","metrics.failed_requests"],colors:["green","red"]})]}),(0,a.jsx)(I.A,{className:"mt-4",data:s.daily_data,index:"date",categories:["metrics.successful_requests","metrics.failed_requests"],colors:["green","red"],valueFormatter:G,customTooltip:Y,showLegend:!1})]}),!l&&(0,a.jsxs)(c.A,{children:[(0,a.jsxs)("div",{className:"flex justify-between items-center",children:[(0,a.jsx)(_.A,{children:t.promptCachingMetrics}),(0,a.jsx)(H,{categories:["metrics.cache_read_input_tokens","metrics.cache_creation_input_tokens"],colors:["cyan","purple"]})]}),(0,a.jsxs)("div",{className:"mb-2",children:[(0,a.jsxs)(g.A,{children:[t.cacheRead,": ",s.total_cache_read_input_tokens?.toLocaleString()||0," ",t.tokens]}),(0,a.jsxs)(g.A,{children:[t.cacheCreation,": ",s.total_cache_creation_input_tokens?.toLocaleString()||0," ",t.tokens]})]}),(0,a.jsx)(I.A,{className:"mt-4",data:s.daily_data,index:"date",categories:["metrics.cache_read_input_tokens","metrics.cache_creation_input_tokens"],colors:["cyan","purple"],valueFormatter:G,customTooltip:Y,showLegend:!1})]})]})]}),Q=({modelMetrics:e,hidePromptCachingMetrics:s=!1})=>{let{locale:t}=(0,q.o)(),l="zh-CN"===t,r={totalRequests:l?"总请求数":"Total Requests",totalSuccessfulRequests:l?"成功请求数":"Total Successful Requests",totalTokens:l?"总 Token 数":"Total Tokens",totalSpend:l?"总花费":"Total Spend",avgPerSuccessfulRequest:l?"每次成功请求平均":"avg per successful request",perSuccessfulRequest:l?"每次成功请求":"per successful request",topApiKeysBySpend:l?"按花费排名的 API 密钥":"Top Virtual Keys by Spend",team:l?"分组":"Team",requests:l?"请求":"requests",tokens:"tokens",spendPerDay:l?"每日花费":"Spend per day",requestsPerDay:l?"每日请求数":"Requests per day",successVsFailedRequests:l?"成功请求 vs 失败请求":"Success vs Failed Requests",promptCachingMetrics:l?"Prompt 缓存指标":"Prompt Caching Metrics",cacheRead:l?"缓存读取":"Cache Read",cacheCreation:l?"缓存创建":"Cache Creation",overallUsage:l?"整体用量":"Overall Usage",totalTokensOverTime:l?"Token 总量趋势":"Total Tokens Over Time",totalRequestsOverTime:l?"请求总量趋势":"Total Requests Over Time",unknownItem:l?"未知项":"Unknown Item",unknownModel:l?"未知模型":"Unknown Model"},i=Object.keys(e).sort((s,t)=>""===s?1:""===t?-1:e[t].total_spend-e[s].total_spend),n={total_requests:0,total_successful_requests:0,total_tokens:0,total_spend:0,total_cache_read_input_tokens:0,total_cache_creation_input_tokens:0,daily_data:{}};Object.values(e).forEach(e=>{n.total_requests+=e.total_requests,n.total_successful_requests+=e.total_successful_requests,n.total_tokens+=e.total_tokens,n.total_spend+=e.total_spend,n.total_cache_read_input_tokens+=e.total_cache_read_input_tokens||0,n.total_cache_creation_input_tokens+=e.total_cache_creation_input_tokens||0,e.daily_data.forEach(e=>{n.daily_data[e.date]||(n.daily_data[e.date]={prompt_tokens:0,completion_tokens:0,total_tokens:0,api_requests:0,spend:0,successful_requests:0,failed_requests:0,cache_read_input_tokens:0,cache_creation_input_tokens:0}),n.daily_data[e.date].prompt_tokens+=e.metrics.prompt_tokens,n.daily_data[e.date].completion_tokens+=e.metrics.completion_tokens,n.daily_data[e.date].total_tokens+=e.metrics.total_tokens,n.daily_data[e.date].api_requests+=e.metrics.api_requests,n.daily_data[e.date].spend+=e.metrics.spend,n.daily_data[e.date].successful_requests+=e.metrics.successful_requests,n.daily_data[e.date].failed_requests+=e.metrics.failed_requests,n.daily_data[e.date].cache_read_input_tokens+=e.metrics.cache_read_input_tokens||0,n.daily_data[e.date].cache_creation_input_tokens+=e.metrics.cache_creation_input_tokens||0})});let o=Object.entries(n.daily_data).map(([e,s])=>({date:e,metrics:s})).sort((e,s)=>new Date(e.date).getTime()-new Date(s.date).getTime());return(0,a.jsxs)("div",{className:"space-y-8",children:[(0,a.jsxs)("div",{className:"border rounded-lg p-4",children:[(0,a.jsx)(_.A,{children:r.overallUsage}),(0,a.jsxs)(d.A,{numItems:4,className:"gap-4 mb-4",children:[(0,a.jsxs)(c.A,{children:[(0,a.jsx)(g.A,{children:r.totalRequests}),(0,a.jsx)(_.A,{children:n.total_requests.toLocaleString()})]}),(0,a.jsxs)(c.A,{children:[(0,a.jsx)(g.A,{children:r.totalSuccessfulRequests}),(0,a.jsx)(_.A,{children:n.total_successful_requests.toLocaleString()})]}),(0,a.jsxs)(c.A,{children:[(0,a.jsx)(g.A,{children:r.totalTokens}),(0,a.jsx)(_.A,{children:n.total_tokens.toLocaleString()})]}),(0,a.jsxs)(c.A,{children:[(0,a.jsx)(g.A,{children:r.totalSpend}),(0,a.jsxs)(_.A,{children:["\xa5",(0,$.HY)(n.total_spend,2)]})]})]}),(0,a.jsxs)(d.A,{numItems:2,className:"gap-4",children:[(0,a.jsxs)(c.A,{children:[(0,a.jsxs)("div",{className:"flex justify-between items-center",children:[(0,a.jsx)(_.A,{children:r.totalTokensOverTime}),(0,a.jsx)(H,{categories:["metrics.prompt_tokens","metrics.completion_tokens","metrics.total_tokens"],colors:["blue","cyan","indigo"]})]}),(0,a.jsx)(I.A,{className:"mt-4",data:o,index:"date",categories:["metrics.prompt_tokens","metrics.completion_tokens","metrics.total_tokens"],colors:["blue","cyan","indigo"],valueFormatter:G,customTooltip:Y,showLegend:!1})]}),(0,a.jsxs)(c.A,{children:[(0,a.jsxs)("div",{className:"flex justify-between items-center",children:[(0,a.jsx)(_.A,{children:r.totalRequestsOverTime}),(0,a.jsx)(H,{categories:["metrics.successful_requests","metrics.failed_requests"],colors:["emerald","red"]})]}),(0,a.jsx)(I.A,{className:"mt-4",data:o,index:"date",categories:["metrics.successful_requests","metrics.failed_requests"],colors:["emerald","red"],valueFormatter:e=>e.toLocaleString(),customTooltip:Y,showLegend:!1})]})]})]}),(0,a.jsx)(V.A,{defaultActiveKey:i[0],children:i.map(t=>(0,a.jsx)(V.A.Panel,{header:(0,a.jsxs)("div",{className:"flex justify-between items-center w-full",children:[(0,a.jsx)(_.A,{children:e[t].label||r.unknownItem}),(0,a.jsxs)("div",{className:"flex space-x-4 text-sm text-gray-500",children:[(0,a.jsxs)("span",{children:["\xa5",(0,$.HY)(e[t].total_spend,2)]}),(0,a.jsxs)("span",{children:[e[t].total_requests.toLocaleString()," ",r.requests]})]})]}),children:(0,a.jsx)(X,{modelName:t||r.unknownModel,metrics:e[t],labels:r,hidePromptCachingMetrics:s})},t))})]})},ee=(e,s,t=[])=>{let a={};return e.results.forEach(e=>{Object.entries(e.breakdown[s]||{}).forEach(([l,r])=>{a[l]||(a[l]={label:"api_keys"===s?((e,s,t)=>{let a=e.metadata.key_alias||`key-hash-${s}`,l=e.metadata.team_id;if(l){let e=(0,z.S)(l,t);return e?`${a} (team: ${e})`:`${a} (team_id: ${l})`}return a})(r,l,t):l,total_requests:0,total_successful_requests:0,total_failed_requests:0,total_tokens:0,prompt_tokens:0,completion_tokens:0,total_spend:0,total_cache_read_input_tokens:0,total_cache_creation_input_tokens:0,top_api_keys:[],top_models:[],daily_data:[]}),a[l].total_requests+=r.metrics.api_requests,a[l].prompt_tokens+=r.metrics.prompt_tokens,a[l].completion_tokens+=r.metrics.completion_tokens,a[l].total_tokens+=r.metrics.total_tokens,a[l].total_spend+=r.metrics.spend,a[l].total_successful_requests+=r.metrics.successful_requests,a[l].total_failed_requests+=r.metrics.failed_requests,a[l].total_cache_read_input_tokens+=r.metrics.cache_read_input_tokens||0,a[l].total_cache_creation_input_tokens+=r.metrics.cache_creation_input_tokens||0,a[l].daily_data.push({date:e.date,metrics:{prompt_tokens:r.metrics.prompt_tokens,completion_tokens:r.metrics.completion_tokens,total_tokens:r.metrics.total_tokens,api_requests:r.metrics.api_requests,spend:r.metrics.spend,successful_requests:r.metrics.successful_requests,failed_requests:r.metrics.failed_requests,cache_read_input_tokens:r.metrics.cache_read_input_tokens||0,cache_creation_input_tokens:r.metrics.cache_creation_input_tokens||0}})})}),"api_keys"!==s&&Object.entries(a).forEach(([t,l])=>{let r={};e.results.forEach(e=>{let a=e.breakdown[s]?.[t];a&&"api_key_breakdown"in a&&Object.entries(a.api_key_breakdown||{}).forEach(([e,s])=>{r[e]||(r[e]={api_key:e,key_alias:s.metadata.key_alias,team_id:s.metadata.team_id,spend:0,requests:0,tokens:0}),r[e].spend+=s.metrics.spend,r[e].requests+=s.metrics.api_requests,r[e].tokens+=s.metrics.total_tokens})}),a[t].top_api_keys=Object.values(r).sort((e,s)=>s.spend-e.spend).slice(0,5)}),"api_keys"===s&&Object.entries(a).forEach(([s,t])=>{let l={};e.results.forEach(e=>{Object.entries(e.breakdown.models||{}).forEach(([e,t])=>{if(t&&"api_key_breakdown"in t){let a=t.api_key_breakdown?.[s];a&&(l[e]||(l[e]={model:e,spend:0,requests:0,successful_requests:0,failed_requests:0,tokens:0}),l[e].spend+=a.metrics.spend,l[e].requests+=a.metrics.api_requests,l[e].successful_requests+=a.metrics.successful_requests||0,l[e].failed_requests+=a.metrics.failed_requests||0,l[e].tokens+=a.metrics.total_tokens)}})}),a[s].top_models=Object.values(l).sort((e,s)=>s.spend-e.spend)}),Object.values(a).forEach(e=>{e.daily_data.sort((e,s)=>new Date(e.date).getTime()-new Date(s.date).getTime())}),a};var es=t(38983),et=t(11568),ea=t(34487),el=t(25387),er=t(3373),ei=t(95049),en=t(12120);let ec=({isOpen:e,onClose:s,accessToken:t})=>{let[l]=el.A.useForm(),[r,i]=(0,w.useState)(!1),[n,c]=(0,w.useState)(null),[o,d]=(0,w.useState)(!1),[u,m]=(0,w.useState)("cloudzero"),[x,p]=(0,w.useState)(!1);(0,w.useEffect)(()=>{e&&t&&h()},[e,t]);let h=async()=>{d(!0);try{let e=await fetch("/cloudzero/settings",{method:"GET",headers:{[(0,C.getGlobalLitellmHeaderName)()]:`Bearer ${t}`,"Content-Type":"application/json"}});if(e.ok){let s=await e.json();c(s),l.setFieldsValue({connection_id:s.connection_id})}else if(404!==e.status){let s=await e.json();en.Ay.fromBackend(`Failed to load existing settings: ${s.error||"Unknown error"}`)}}catch(e){console.error("Error loading CloudZero settings:",e),en.Ay.fromBackend("Failed to load existing settings")}finally{d(!1)}},_=async e=>{if(!t)return void en.Ay.fromBackend("No access token available");i(!0);try{let s=n?"/cloudzero/settings":"/cloudzero/init",a=n?"PUT":"POST",l={...e,timezone:"UTC"},r=await fetch(s,{method:a,headers:{[(0,C.getGlobalLitellmHeaderName)()]:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify(l)}),i=await r.json();if(r.ok)return en.Ay.success(i.message||"CloudZero settings saved successfully"),c({api_key_masked:e.api_key.substring(0,4)+"****"+e.api_key.slice(-4),connection_id:e.connection_id,status:"configured"}),!0;return en.Ay.fromBackend(i.error||"Failed to save CloudZero settings"),!1}catch(e){return console.error("Error saving CloudZero settings:",e),en.Ay.fromBackend("Failed to save CloudZero settings"),!1}finally{i(!1)}},f=async()=>{if(!t)return void en.Ay.fromBackend("No access token available");p(!0);try{let e=await fetch("/cloudzero/export",{method:"POST",headers:{[(0,C.getGlobalLitellmHeaderName)()]:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify({limit:1e5,operation:"replace_hourly"})}),a=await e.json();e.ok?(en.Ay.success(a.message||"Export to CloudZero completed successfully"),s()):en.Ay.fromBackend(a.error||"Failed to export to CloudZero")}catch(e){console.error("Error exporting to CloudZero:",e),en.Ay.fromBackend("Failed to export to CloudZero")}finally{p(!1)}},y=async()=>{p(!0);try{en.Ay.info("CSV export functionality coming soon!"),s()}catch(e){console.error("Error exporting CSV:",e),en.Ay.fromBackend("Failed to export CSV")}finally{p(!1)}},k=async()=>{if("cloudzero"===u){if(!n){let e=await l.validateFields();if(!await _(e))return}await f()}else await y()},b=()=>{l.resetFields(),m("cloudzero"),c(null),s()},A=[{value:"cloudzero",label:(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)("img",{src:"/cloudzero.png",alt:"CloudZero",className:"w-5 h-5",onError:e=>{e.target.style.display="none"}}),(0,a.jsx)("span",{children:"Export to CloudZero"})]})},{value:"csv",label:(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})}),(0,a.jsx)("span",{children:"Export to CSV"})]})}];return(0,a.jsx)(er.A,{title:"Export Data",open:e,onCancel:b,footer:null,width:600,destroyOnHidden:!0,children:(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)(g.A,{className:"font-medium mb-2 block",children:"Export Destination"}),(0,a.jsx)(j.A,{value:u,onChange:m,options:A,className:"w-full",size:"large"})]}),"cloudzero"===u&&(0,a.jsx)("div",{children:o?(0,a.jsx)("div",{className:"flex justify-center py-8",children:(0,a.jsx)(ei.A,{size:"large"})}):(0,a.jsxs)(a.Fragment,{children:[n&&(0,a.jsx)(et.A,{title:"Existing CloudZero Configuration",icon:()=>(0,a.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"})}),color:"green",className:"mb-4",children:(0,a.jsxs)(g.A,{children:["API Key: ",n.api_key_masked,(0,a.jsx)("br",{}),"Connection ID: ",n.connection_id]})}),!n&&(0,a.jsxs)(el.A,{form:l,layout:"vertical",children:[(0,a.jsx)(el.A.Item,{label:"CloudZero API Key",name:"api_key",rules:[{required:!0,message:"Please enter your CloudZero API key"}],children:(0,a.jsx)(ea.A,{type:"password",placeholder:"Enter your CloudZero API key"})}),(0,a.jsx)(el.A.Item,{label:"Connection ID",name:"connection_id",rules:[{required:!0,message:"Please enter the CloudZero connection ID"}],children:(0,a.jsx)(ea.A,{placeholder:"Enter CloudZero connection ID"})})]})]})}),"csv"===u&&(0,a.jsx)(et.A,{title:"CSV Export",icon:()=>(0,a.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 6v6m0 0v6m0-6h6m-6 0H6"})}),color:"blue",children:(0,a.jsx)(g.A,{children:"Export your usage data as a CSV file for analysis in spreadsheet applications."})}),(0,a.jsxs)("div",{className:"flex justify-end space-x-2 pt-4",children:[(0,a.jsx)(es.A,{variant:"secondary",onClick:b,children:"Cancel"}),(0,a.jsx)(es.A,{onClick:k,loading:r||x,disabled:r||x,children:"cloudzero"===u?"Export to CloudZero":"Export CSV"})]})]})})};var eo=t(4862),ed=t(8536),eu=t(87278);let em=({value:e,onChange:s})=>{let{t}=(0,q.o)();return(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"text-sm font-medium text-gray-700 block mb-2",children:t("usagePage.exportModal.format")}),(0,a.jsx)(j.A,{value:e,onChange:s,className:"w-full",options:[{value:"csv",label:t("usagePage.exportModal.csvOption")},{value:"json",label:t("usagePage.exportModal.jsonOption")}]})]})},ex=({dateRange:e,selectedFilters:s})=>{let{t}=(0,q.o)(),l=e=>e?`${e.getFullYear()}/${e.getMonth()+1}/${e.getDate()}`:"";return(0,a.jsxs)("div",{className:"text-sm text-gray-500",children:[l(e.from)," - ",l(e.to),s.length>0&&` \xb7 ${s.length}${t("usagePage.exportModal.filtersAppliedSuffix")}`]})};var ep=t(55895);let eh=({value:e,onChange:s,entityType:t})=>{let{t:l}=(0,q.o)(),r={team:l("usagePage.exportModal.entity.team"),tag:l("usagePage.exportModal.entity.tag"),organization:l("usagePage.exportModal.entity.organization"),customer:l("usagePage.exportModal.entity.customer"),agent:l("usagePage.exportModal.entity.agent")}[t];return(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"text-sm font-medium text-gray-700 block mb-2",children:l("usagePage.exportModal.exportType")}),(0,a.jsx)(ep.Ay.Group,{value:e,onChange:e=>s(e.target.value),className:"w-full",children:(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsxs)("label",{className:"flex items-start p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer transition-colors",children:[(0,a.jsx)(ep.Ay,{value:"daily",className:"mt-0.5"}),(0,a.jsxs)("div",{className:"ml-3 flex-1",children:[(0,a.jsx)("div",{className:"font-medium text-sm",children:l("usagePage.exportModal.dailyByEntityTitle").replace("{entity}",r)}),(0,a.jsx)("div",{className:"text-xs text-gray-500 mt-0.5",children:l("usagePage.exportModal.dailyByEntityDesc").replace("{entity}",r)})]})]}),(0,a.jsxs)("label",{className:"flex items-start p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer transition-colors",children:[(0,a.jsx)(ep.Ay,{value:"daily_with_keys",className:"mt-0.5"}),(0,a.jsxs)("div",{className:"ml-3 flex-1",children:[(0,a.jsx)("div",{className:"font-medium text-sm",children:l("usagePage.exportModal.dailyByEntityAndKeyTitle").replace("{entity}",r)}),(0,a.jsx)("div",{className:"text-xs text-gray-500 mt-0.5",children:l("usagePage.exportModal.dailyByEntityAndKeyDesc").replace("{entity}",r)})]})]}),(0,a.jsxs)("label",{className:"flex items-start p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer transition-colors",children:[(0,a.jsx)(ep.Ay,{value:"daily_with_models",className:"mt-0.5"}),(0,a.jsxs)("div",{className:"ml-3 flex-1",children:[(0,a.jsx)("div",{className:"font-medium text-sm",children:l("usagePage.exportModal.dailyByEntityAndModelTitle").replace("{entity}",r)}),(0,a.jsx)("div",{className:"text-xs text-gray-500 mt-0.5",children:l("usagePage.exportModal.dailyByEntityAndModelDesc")})]})]})]})})]})};var eg=t(38545),e_=t.n(eg),ej=t(59386),ef=t.n(ej);N().extend(e_());let ey=e=>{if(!e)return null;for(let s of Object.values(e)){let e=s?.metadata?.team_id;if(e)return e}return null},ek=()=>({spend:0,api_requests:0,successful_requests:0,failed_requests:0,total_tokens:0,prompt_tokens:0,completion_tokens:0}),eb=(e,s)=>{s&&(e.spend+=s.spend||0,e.api_requests+=s.api_requests||0,e.successful_requests+=s.successful_requests||0,e.failed_requests+=s.failed_requests||0,e.total_tokens+=s.total_tokens||0,e.prompt_tokens+=s.prompt_tokens||0,e.completion_tokens+=s.completion_tokens||0)},eA=e=>{let s,t=e?.breakdown?.entities||{};return Object.keys(t).length>0?t:(s={},Object.entries(e?.breakdown?.api_keys||{}).forEach(([e,t])=>{let a=t?.metadata?.team_id||"Unassigned";s[a]||(s[a]={metrics:ek(),api_key_breakdown:{}}),eb(s[a].metrics,t?.metrics),s[a].api_key_breakdown[e]||(s[a].api_key_breakdown[e]={metrics:ek(),metadata:t?.metadata||{}}),eb(s[a].api_key_breakdown[e].metrics,t?.metrics)}),0===Object.keys(s).length&&e?.metrics&&(s.Unassigned={metrics:{spend:e.metrics.spend||0,api_requests:e.metrics.api_requests||0,successful_requests:e.metrics.successful_requests||0,failed_requests:e.metrics.failed_requests||0,total_tokens:e.metrics.total_tokens||0,prompt_tokens:e.metrics.prompt_tokens||0,completion_tokens:e.metrics.completion_tokens||0},api_key_breakdown:{}}),s)},ev=(e,s,t,a={})=>{switch(s){case"daily":default:return((e,s,t={})=>{let a=[];return e.results.forEach(e=>{Object.entries(eA(e)).forEach(([l,r])=>{let i=ey(r.api_key_breakdown),n=i&&t[i]||null;a.push({Date:e.date,[s]:n||"-",[`${s} ID`]:i||"-","Spend (\xa5)":(0,$.HY)(r.metrics.spend,4),Requests:r.metrics.api_requests,"Successful Requests":r.metrics.successful_requests,"Failed Requests":r.metrics.failed_requests,"Total Tokens":r.metrics.total_tokens,"Prompt Tokens":r.metrics.prompt_tokens||0,"Completion Tokens":r.metrics.completion_tokens||0})})}),a.sort((e,s)=>new Date(e.Date).getTime()-new Date(s.Date).getTime())})(e,t,a);case"daily_with_keys":return((e,s,t={})=>{let a={};return e.results.forEach(e=>{Object.entries(eA(e)).forEach(([s,l])=>{Object.entries(l.api_key_breakdown||{}).forEach(([l,r])=>{let i=r?.metadata?.key_alias||null,n=r?.metadata?.team_id||s,c=n&&t[n]||null,o=`${e.date}_${n}_${l}`;a[o]?(a[o].metrics.spend+=r.metrics?.spend||0,a[o].metrics.api_requests+=r.metrics?.api_requests||0,a[o].metrics.successful_requests+=r.metrics?.successful_requests||0,a[o].metrics.failed_requests+=r.metrics?.failed_requests||0,a[o].metrics.total_tokens+=r.metrics?.total_tokens||0,a[o].metrics.prompt_tokens+=r.metrics?.prompt_tokens||0,a[o].metrics.completion_tokens+=r.metrics?.completion_tokens||0):a[o]={Date:e.date,teamId:n,teamAlias:c,keyId:l,keyAlias:i,metrics:{spend:r.metrics?.spend||0,api_requests:r.metrics?.api_requests||0,successful_requests:r.metrics?.successful_requests||0,failed_requests:r.metrics?.failed_requests||0,total_tokens:r.metrics?.total_tokens||0,prompt_tokens:r.metrics?.prompt_tokens||0,completion_tokens:r.metrics?.completion_tokens||0}}})})}),Object.values(a).map(e=>({Date:e.Date,[s]:e.teamAlias||"-",[`${s} ID`]:e.teamId||"-","Key Alias":e.keyAlias||"-","Key ID":e.keyId,"Spend (\xa5)":(0,$.HY)(e.metrics.spend,4),Requests:e.metrics.api_requests,"Successful Requests":e.metrics.successful_requests,"Failed Requests":e.metrics.failed_requests,"Total Tokens":e.metrics.total_tokens,"Prompt Tokens":e.metrics.prompt_tokens,"Completion Tokens":e.metrics.completion_tokens})).sort((e,s)=>new Date(e.Date).getTime()-new Date(s.Date).getTime())})(e,t,a);case"daily_with_models":return((e,s,t={})=>{let a=[];return e.results.forEach(e=>{if(0===Object.keys(e?.breakdown?.entities||{}).length){let l={};Object.entries(e?.breakdown?.models||{}).forEach(([s,a])=>{Object.entries(a?.api_key_breakdown||{}).forEach(([a,r])=>{let i=r?.metadata?.team_id||"Unassigned",n=t[i]||null,c=`${e.date}_${i}_${s}`;l[c]||(l[c]={Date:e.date,teamId:i,teamAlias:n,model:s,metrics:{spend:0,requests:0,successful:0,failed:0,tokens:0}}),l[c].metrics.spend+=r?.metrics?.spend||0,l[c].metrics.requests+=r?.metrics?.api_requests||0,l[c].metrics.successful+=r?.metrics?.successful_requests||0,l[c].metrics.failed+=r?.metrics?.failed_requests||0,l[c].metrics.tokens+=r?.metrics?.total_tokens||0})}),Object.values(l).forEach(e=>{a.push({Date:e.Date,[s]:e.teamAlias||"-",[`${s} ID`]:e.teamId||"-",Model:e.model,"Spend (\xa5)":(0,$.HY)(e.metrics.spend,4),Requests:e.metrics.requests,Successful:e.metrics.successful,Failed:e.metrics.failed,"Total Tokens":e.metrics.tokens})});return}let l={};Object.entries(e.breakdown.entities||{}).forEach(([s,t])=>{l[s]||(l[s]={}),Object.entries(e.breakdown.models||{}).forEach(([e,a])=>{Object.entries(t.api_key_breakdown||{}).forEach(([t,a])=>{l[s][e]||(l[s][e]={spend:0,requests:0,successful:0,failed:0,tokens:0}),l[s][e].spend+=a.metrics.spend||0,l[s][e].requests+=a.metrics.api_requests||0,l[s][e].successful+=a.metrics.successful_requests||0,l[s][e].failed+=a.metrics.failed_requests||0,l[s][e].tokens+=a.metrics.total_tokens||0})})}),Object.entries(l).forEach(([l,r])=>{let i=e.breakdown.entities?.[l],n=ey(i?.api_key_breakdown),c=n&&t[n]||null;Object.entries(r).forEach(([t,l])=>{a.push({Date:e.date,[s]:c||"-",[`${s} ID`]:n||"-",Model:t,"Spend (\xa5)":(0,$.HY)(l.spend,4),Requests:l.requests,Successful:l.successful,Failed:l.failed,"Total Tokens":l.tokens})})})}),a.sort((e,s)=>new Date(e.Date).getTime()-new Date(s.Date).getTime())})(e,t,a)}},eN=(e,s,t)=>{let a,l,r,i=t||(e=>{let s=e.from?N()(e.from):null,t=e.to?N()(e.to):null;if(s&&t){if(s.startOf("month").isSame(s,"day")&&t.endOf("month").startOf("day").isSame(t.startOf("day"),"day"))return"month";if(s.startOf("week").isSame(s,"day")&&t.endOf("week").startOf("day").isSame(t.startOf("day"),"day"))return"week"}return"day"})(s);return`${"week"===i?"周账单":"month"===i?"月账单":"日账单"}-${a=s.from?N()(s.from):null,l=s.to?N()(s.to):null,r="day"===i?l||a||N()():a||l||N()(),"week"===i?`${r.year()}年${r.week()}周`:"month"===i?`${r.year()}年${r.month()+1}月`:`${r.year()}年${r.month()+1}月${r.date()}日`}-${"daily_with_keys"===e?"分组与API密钥明细":"daily_with_models"===e?"分组与模型明细":"分组明细"}`},ew=({isOpen:e,onClose:s,entityType:t,spendData:l,dateRange:r,timeRangeType:i,selectedFilters:n,customTitle:c})=>{let{t:o}=(0,q.o)(),[d,u]=(0,w.useState)("csv"),[m,x]=(0,w.useState)("daily"),[p,h]=(0,w.useState)(!1),{data:g,isLoading:_}=(0,eo.S3)(),j=t.charAt(0).toUpperCase()+t.slice(1),f=c||`Export ${j} Usage`,y=(0,w.useMemo)(()=>(0,z.O)(g),[g]),k=async e=>{let a=e||d;h(!0);try{"csv"===a?(((e,s,t,a,l,r,i={})=>{let n=ev(e,s,t,i),c=l.to?N()(l.to).format("YYYY-MM-DD"):N()().format("YYYY-MM-DD"),o=n.length>0?n:[{Date:c,[t]:"-",[`${t} ID`]:"-","Spend (\xa5)":(0,$.HY)(e?.metadata?.total_spend||0,4),Requests:e?.metadata?.total_api_requests||0,"Successful Requests":e?.metadata?.total_successful_requests||0,"Failed Requests":e?.metadata?.total_failed_requests||0,"Total Tokens":e?.metadata?.total_tokens||0,"Prompt Tokens":0,"Completion Tokens":0}],d=new Blob([ef().unparse(o)],{type:"text/csv;charset=utf-8;"}),u=window.URL.createObjectURL(d),m=document.createElement("a");m.href=u,m.download=`${eN(s,l,r)}.csv`,document.body.appendChild(m),m.click(),document.body.removeChild(m),window.URL.revokeObjectURL(u)})(l,m,j,0,r,i,y),en.Ay.success(o("usagePage.exportModal.exportSuccessCsv"))):(((e,s,t,a,l,r,i,n={})=>{let c=ev(e,s,t,n),o={export_date:new Date().toISOString(),entity_type:a,date_range:{from:l.from?.toISOString(),to:l.to?.toISOString()},filters_applied:i.length>0?i:"None",export_scope:s,summary:{total_spend:e.metadata.total_spend,total_requests:e.metadata.total_api_requests,successful_requests:e.metadata.total_successful_requests,failed_requests:e.metadata.total_failed_requests,total_tokens:e.metadata.total_tokens}},d=new Blob([JSON.stringify({metadata:o,data:c},null,2)],{type:"application/json"}),u=window.URL.createObjectURL(d),m=document.createElement("a");m.href=u,m.download=`${eN(s,l,r)}.json`,document.body.appendChild(m),m.click(),document.body.removeChild(m),window.URL.revokeObjectURL(u)})(l,m,j,t,r,i,n,y),en.Ay.success(o("usagePage.exportModal.exportSuccessJson"))),s()}catch(e){console.error("Error exporting data:",e),en.Ay.fromBackend(o("usagePage.exportModal.exportFailed"))}finally{h(!1)}};return(0,a.jsx)(er.A,{title:(0,a.jsx)("span",{className:"text-base font-semibold",children:f}),open:e,onCancel:s,footer:null,width:480,children:(0,a.jsxs)("div",{className:"space-y-5 py-2",children:[_?(0,a.jsx)(ed.A,{active:!0}):(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(ex,{dateRange:r,selectedFilters:n}),(0,a.jsx)(eh,{value:m,onChange:x,entityType:t}),(0,a.jsx)(em,{value:d,onChange:u})]}),_?(0,a.jsxs)("div",{className:"flex items-center justify-end gap-2 pt-4 border-t",children:[(0,a.jsx)(ed.A.Button,{active:!0}),(0,a.jsx)(ed.A.Button,{active:!0})]}):(0,a.jsxs)("div",{className:"flex items-center justify-end gap-2 pt-4 border-t",children:[(0,a.jsx)(eu.Ay,{variant:"outlined",onClick:s,disabled:p,children:o("usagePage.exportModal.cancel")}),(0,a.jsx)(eu.Ay,{onClick:()=>k(),loading:p||_,disabled:p||_,type:"primary",children:p?o("usagePage.exportModal.exporting"):"csv"===d?o("usagePage.exportModal.exportCsv"):o("usagePage.exportModal.exportJson")})]})]})})};var eq=t(50410);let eS=({dateValue:e,timeRangeType:s,entityType:t,spendData:l,showFilters:r=!1,filterLabel:i,filterPlaceholder:n,selectedFilters:c=[],onFiltersChange:o,filterOptions:d=[],customTitle:u,compactLayout:m=!1,teams:x=[]})=>{let[p,h]=(0,w.useState)(!1);return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("div",{className:"mb-4",children:(0,a.jsxs)("div",{className:`grid ${r&&d.length>0?"grid-cols-[1fr_auto]":"grid-cols-[auto]"} items-end gap-4`,children:[r&&d.length>0&&(0,a.jsxs)("div",{children:[i&&(0,a.jsx)(eq.E,{className:"mb-2",children:i}),(0,a.jsx)(j.A,{mode:"multiple",style:{width:"100%"},placeholder:n,value:c,onChange:o,options:d,allowClear:!0})]}),(0,a.jsx)("div",{className:"justify-self-end",children:(0,a.jsx)(eq.$,{onClick:()=>h(!0),icon:()=>(0,a.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"})}),children:"Export Data"})})]})}),(0,a.jsx)(ew,{isOpen:p,onClose:()=>h(!1),entityType:t,spendData:l,dateRange:e,timeRangeType:s,selectedFilters:c,customTitle:u,teams:x})]})};var eC=t(78629),eP=t(54481),eT=t(71958),eD=t(5201);t(702);let{Text:eE}=b.A,{RangePicker:eL}=eC.A;N().extend(e_());let eM=e=>({from:e.startOf("week").startOf("day").toDate(),to:e.endOf("week").endOf("day").toDate()}),eO=e=>({from:e.startOf("month").startOf("day").toDate(),to:e.endOf("month").endOf("day").toDate()}),eU=({value:e,onValueChange:s,className:t})=>{let{t:l,locale:r}=(0,q.o)(),[i,n]=(0,w.useState)("week"),c="zh-CN"===r?eT.A:eD.A;(0,w.useEffect)(()=>{N().locale("zh-CN"===r?"zh-cn":"en")},[r]),(0,w.useEffect)(()=>{s(eM(N()()),"week")},[]);let o=(0,w.useCallback)(t=>{n(t);let a=N()(e.to||e.from||new Date);"week"===t?s(eM(a),"week"):"month"===t&&s(eO(a),"month")},[s,e.from,e.to]),d=(0,w.useCallback)(e=>{e&&e[0]&&e[1]&&s({from:e[0].startOf("day").toDate(),to:e[1].endOf("day").toDate()},"day")},[s]),u=(0,w.useCallback)(e=>{e&&s(eM(e),"week")},[s]),m=(0,w.useCallback)(e=>{e&&s(eO(e),"month")},[s]);return(0,a.jsx)("div",{className:t,children:(0,a.jsxs)(eP.A,{size:8,wrap:!0,className:"rounded-xl border border-gray-200 bg-white px-3 py-2 shadow-sm",children:[(0,a.jsx)(eE,{type:"secondary",className:"whitespace-nowrap text-xs",children:l("usagePage.datePicker.type")}),(0,a.jsx)(j.A,{value:i,onChange:o,style:{width:120},options:[{label:l("usagePage.datePicker.day"),value:"day"},{label:l("usagePage.datePicker.week"),value:"week"},{label:l("usagePage.datePicker.month"),value:"month"}]}),"day"===i&&(0,a.jsx)(eL,{locale:c,value:[e.from?N()(e.from):null,e.to?N()(e.to):null],onChange:d,allowClear:!1,inputReadOnly:!0,placeholder:[l("usagePage.datePicker.placeholder.day"),l("usagePage.datePicker.placeholder.day")]}),"week"===i&&(0,a.jsx)(eC.A,{locale:c,picker:"week",value:e.from?N()(e.from):null,onChange:u,allowClear:!1,inputReadOnly:!0,format:e=>`${e.year()}年${e.week()}周`,placeholder:l("usagePage.datePicker.placeholder.week")}),"month"===i&&(0,a.jsx)(eC.A,{locale:c,picker:"month",value:e.from?N()(e.from):null,onChange:m,allowClear:!1,inputReadOnly:!0,format:"zh-CN"===r?"YYYY年M月":"YYYY-MM",placeholder:l("usagePage.datePicker.placeholder.month")})]})})};var eF=t(95480);let e$=({isDateChanging:e=!1})=>(0,a.jsx)("div",{className:"flex items-center justify-center h-40",children:(0,a.jsxs)("div",{className:"flex items-center justify-center gap-3",children:[(0,a.jsx)(eF.S,{className:"size-5"}),(0,a.jsxs)("div",{className:"flex flex-col",children:[(0,a.jsx)("span",{className:"text-gray-600 text-sm font-medium",children:e?"Processing date selection...":"Loading chart data..."}),(0,a.jsx)("span",{className:"text-gray-400 text-xs mt-1",children:e?"This will only take a moment":"Fetching your data"})]})]})});var eR=t(8938),ez=t(39210),eI=t(30489),eV=t(96961),eK=t(95517),eY=t(8179),eH=t(31556),eB=t(95171);let eW=({accessToken:e,selectedTags:s,formatAbbreviatedNumber:t})=>{let l,r,i,c,[o,d]=(0,w.useState)({results:[],total_count:0,page:1,page_size:50,total_pages:0}),[j,f]=(0,w.useState)(!1),[y,k]=(0,w.useState)(1),b=async()=>{if(e){f(!0);try{let t=await (0,C.perUserAnalyticsCall)(e,y,50,s.length>0?s:void 0);d(t)}catch(e){console.error("Failed to fetch per-user data:",e)}finally{f(!1)}}};return(0,w.useEffect)(()=>{b()},[e,s,y]),(0,a.jsxs)("div",{className:"mb-6",children:[(0,a.jsx)(_.A,{children:"Per User Usage"}),(0,a.jsx)(ez.A,{children:"Individual developer usage metrics"}),(0,a.jsxs)(m.A,{children:[(0,a.jsxs)(x.A,{className:"mb-6",children:[(0,a.jsx)(u.A,{children:"User Details"}),(0,a.jsx)(u.A,{children:"Usage Distribution"})]}),(0,a.jsxs)(h.A,{children:[(0,a.jsxs)(p.A,{children:[(0,a.jsxs)(eI.A,{children:[(0,a.jsx)(eY.A,{children:(0,a.jsxs)(eB.A,{children:[(0,a.jsx)(eH.A,{children:"User ID"}),(0,a.jsx)(eH.A,{children:"User Email"}),(0,a.jsx)(eH.A,{children:"User Agent"}),(0,a.jsx)(eH.A,{className:"text-right",children:"Success Generations"}),(0,a.jsx)(eH.A,{className:"text-right",children:"Total Tokens"}),(0,a.jsx)(eH.A,{className:"text-right",children:"Failed Requests"}),(0,a.jsx)(eH.A,{className:"text-right",children:"Total Cost"})]})}),(0,a.jsx)(eV.A,{children:o.results.slice(0,10).map((e,s)=>(0,a.jsxs)(eB.A,{children:[(0,a.jsx)(eK.A,{children:(0,a.jsx)(g.A,{className:"font-medium",children:e.user_id})}),(0,a.jsx)(eK.A,{children:(0,a.jsx)(g.A,{children:e.user_email||"N/A"})}),(0,a.jsx)(eK.A,{children:(0,a.jsx)(g.A,{children:e.user_agent||"Unknown"})}),(0,a.jsx)(eK.A,{className:"text-right",children:(0,a.jsx)(g.A,{children:t(e.successful_requests)})}),(0,a.jsx)(eK.A,{className:"text-right",children:(0,a.jsx)(g.A,{children:t(e.total_tokens)})}),(0,a.jsx)(eK.A,{className:"text-right",children:(0,a.jsx)(g.A,{children:t(e.failed_requests)})}),(0,a.jsx)(eK.A,{className:"text-right",children:(0,a.jsxs)(g.A,{children:["$",t(e.spend,4)]})})]},s))})]}),o.results.length>10&&(0,a.jsxs)("div",{className:"mt-4 flex justify-between items-center",children:[(0,a.jsxs)(g.A,{className:"text-sm text-gray-500",children:["Showing 10 of ",o.total_count," results"]}),(0,a.jsxs)("div",{className:"flex gap-2",children:[(0,a.jsx)(es.A,{size:"sm",variant:"secondary",onClick:()=>{y>1&&k(y-1)},disabled:1===y,children:"Previous"}),(0,a.jsx)(es.A,{size:"sm",variant:"secondary",onClick:()=>{y<o.total_pages&&k(y+1)},disabled:y>=o.total_pages,children:"Next"})]})]})]}),(0,a.jsxs)(p.A,{children:[(0,a.jsxs)("div",{className:"mb-4",children:[(0,a.jsx)(_.A,{className:"text-lg",children:"User Usage Distribution"}),(0,a.jsx)(ez.A,{children:"Number of users by successful request frequency"})]}),(0,a.jsx)(n.A,{data:(l=new Map,o.results.forEach(e=>{let s=e.user_agent||"Unknown";l.set(s,(l.get(s)||0)+1)}),r=Array.from(l.entries()).sort(([,e],[,s])=>s-e).slice(0,8).map(([e])=>e),i={"1-9 requests":{range:[1,9],agents:{}},"10-99 requests":{range:[10,99],agents:{}},"100-999 requests":{range:[100,999],agents:{}},"1K-9.9K requests":{range:[1e3,9999],agents:{}},"10K-99.9K requests":{range:[1e4,99999],agents:{}},"100K+ requests":{range:[1e5,1/0],agents:{}}},o.results.forEach(e=>{let s=e.successful_requests,t=e.user_agent||"Unknown";r.includes(t)&&Object.entries(i).forEach(([e,a])=>{s>=a.range[0]&&s<=a.range[1]&&(a.agents[t]||(a.agents[t]=0),a.agents[t]++)})}),Object.entries(i).map(([e,s])=>{let t={category:e};return r.forEach(e=>{t[e]=s.agents[e]||0}),t})),index:"category",categories:(c=new Map,o.results.forEach(e=>{let s=e.user_agent||"Unknown";c.set(s,(c.get(s)||0)+1)}),Array.from(c.entries()).sort(([,e],[,s])=>s-e).slice(0,8).map(([e])=>e)),colors:["blue","green","orange","red","purple","yellow","pink","indigo"],valueFormatter:e=>`${e} users`,yAxisWidth:80,showLegend:!0,stack:!0})]})]})]})]})},eZ=({accessToken:e,userRole:s,dateValue:t,onDateChange:l})=>{let[r,i]=(0,w.useState)({results:[]}),[o,y]=(0,w.useState)({results:[]}),[k,b]=(0,w.useState)({results:[]}),[A,v]=(0,w.useState)({results:[]}),[N,q]=(0,w.useState)(""),[S,P]=(0,w.useState)([]),[T,D]=(0,w.useState)([]),[E,L]=(0,w.useState)(!1),[M,O]=(0,w.useState)(!1),[U,F]=(0,w.useState)(!1),[$,R]=(0,w.useState)(!1),[z,I]=(0,w.useState)(!1),V=new Date,K=async()=>{if(e){L(!0);try{let s=await (0,C.tagDistinctCall)(e);P(s.results.map(e=>e.tag))}catch(e){console.error("Failed to fetch available tags:",e)}finally{L(!1)}}},Y=async()=>{if(e){O(!0);try{let s=await (0,C.tagDauCall)(e,V,N||void 0,T.length>0?T:void 0);i(s)}catch(e){console.error("Failed to fetch DAU data:",e)}finally{O(!1)}}},H=async()=>{if(e){F(!0);try{let s=await (0,C.tagWauCall)(e,V,N||void 0,T.length>0?T:void 0);y(s)}catch(e){console.error("Failed to fetch WAU data:",e)}finally{F(!1)}}},B=async()=>{if(e){R(!0);try{let s=await (0,C.tagMauCall)(e,V,N||void 0,T.length>0?T:void 0);b(s)}catch(e){console.error("Failed to fetch MAU data:",e)}finally{R(!1)}}},W=async()=>{if(e&&t.from&&t.to){I(!0);try{let s=await (0,C.userAgentSummaryCall)(e,t.from,t.to,T.length>0?T:void 0);v(s)}catch(e){console.error("Failed to fetch user agent summary data:",e)}finally{I(!1)}}};(0,w.useEffect)(()=>{K()},[e]),(0,w.useEffect)(()=>{if(!e)return;let s=setTimeout(()=>{Y(),H(),B()},50);return()=>clearTimeout(s)},[e,N,T]),(0,w.useEffect)(()=>{if(!t.from||!t.to)return;let e=setTimeout(()=>{W()},50);return()=>clearTimeout(e)},[e,t,T]);let Z=e=>e.startsWith("User-Agent: ")?e.replace("User-Agent: ",""):e,G=e=>Object.entries(e.reduce((e,s)=>(e[s.tag]=(e[s.tag]||0)+s.active_users,e),{})).sort(([,e],[,s])=>s-e).map(([e])=>e),J=G(r.results).slice(0,10),X=G(o.results).slice(0,10),Q=G(k.results).slice(0,10),ee=(()=>{let e=[],s=new Date;for(let t=6;t>=0;t--){let a=new Date(s);a.setDate(a.getDate()-t);let l={date:a.toISOString().split("T")[0]};J.forEach(e=>{l[Z(e)]=0}),e.push(l)}return r.results.forEach(s=>{let t=Z(s.tag),a=e.find(e=>e.date===s.date);a&&(a[t]=s.active_users)}),e})(),es=(()=>{let e=[];for(let s=1;s<=7;s++){let t={week:`Week ${s}`};X.forEach(e=>{t[Z(e)]=0}),e.push(t)}return o.results.forEach(s=>{let t=Z(s.tag),a=s.date.match(/Week (\d+)/);if(a){let l=`Week ${a[1]}`,r=e.find(e=>e.week===l);r&&(r[t]=s.active_users)}}),e})(),et=(()=>{let e=[];for(let s=1;s<=7;s++){let t={month:`Month ${s}`};Q.forEach(e=>{t[Z(e)]=0}),e.push(t)}return k.results.forEach(s=>{let t=Z(s.tag),a=s.date.match(/Month (\d+)/);if(a){let l=`Month ${a[1]}`,r=e.find(e=>e.month===l);r&&(r[t]=s.active_users)}}),e})(),ea=(e,s=0)=>{if(e>=1e8||e>=1e7)return(e/1e6).toFixed(s)+"M";if(e>=1e6)return(e/1e6).toFixed(s)+"M";if(e>=1e4)return(e/1e3).toFixed(s)+"K";if(e>=1e3)return(e/1e3).toFixed(s)+"K";else return e.toFixed(s)};return(0,a.jsxs)("div",{className:"space-y-6 mt-6",children:[(0,a.jsx)(c.A,{children:(0,a.jsxs)("div",{className:"space-y-6",children:[(0,a.jsxs)("div",{className:"flex justify-between items-start",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)(_.A,{children:"Summary by User Agent"}),(0,a.jsx)(ez.A,{children:"Performance metrics for different user agents"})]}),(0,a.jsxs)("div",{className:"w-96",children:[(0,a.jsx)(g.A,{className:"text-sm font-medium block mb-2",children:"Filter by User Agents"}),(0,a.jsx)(j.A,{mode:"multiple",placeholder:"All User Agents",value:T,onChange:D,style:{width:"100%"},showSearch:!0,allowClear:!0,loading:E,optionFilterProp:"label",className:"rounded-md",maxTagCount:"responsive",children:S.map(e=>{let s=Z(e),t=s.length>50?`${s.substring(0,50)}...`:s;return(0,a.jsx)(j.A.Option,{value:e,label:t,title:s,children:t},e)})})]})]}),z?(0,a.jsx)(e$,{isDateChanging:!1}):(0,a.jsxs)(d.A,{numItems:4,className:"gap-4",children:[(A.results||[]).slice(0,4).map((e,s)=>{let t=Z(e.tag),l=t.length>15?t.substring(0,15)+"...":t;return(0,a.jsxs)(c.A,{children:[(0,a.jsx)(f.A,{title:t,placement:"top",children:(0,a.jsx)(_.A,{className:"truncate",children:l})}),(0,a.jsxs)("div",{className:"mt-4 space-y-3",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)(g.A,{className:"text-sm text-gray-600",children:"Success Requests"}),(0,a.jsx)(eR.A,{className:"text-lg",children:ea(e.successful_requests)})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)(g.A,{className:"text-sm text-gray-600",children:"Total Tokens"}),(0,a.jsx)(eR.A,{className:"text-lg",children:ea(e.total_tokens)})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)(g.A,{className:"text-sm text-gray-600",children:"Total Cost"}),(0,a.jsxs)(eR.A,{className:"text-lg",children:["$",ea(e.total_spend,4)]})]})]})]},s)}),Array.from({length:Math.max(0,4-(A.results||[]).length)}).map((e,s)=>(0,a.jsxs)(c.A,{children:[(0,a.jsx)(_.A,{children:"No Data"}),(0,a.jsxs)("div",{className:"mt-4 space-y-3",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)(g.A,{className:"text-sm text-gray-600",children:"Success Requests"}),(0,a.jsx)(eR.A,{className:"text-lg",children:"-"})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)(g.A,{className:"text-sm text-gray-600",children:"Total Tokens"}),(0,a.jsx)(eR.A,{className:"text-lg",children:"-"})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)(g.A,{className:"text-sm text-gray-600",children:"Total Cost"}),(0,a.jsx)(eR.A,{className:"text-lg",children:"-"})]})]})]},`empty-${s}`))]})]})}),(0,a.jsx)(c.A,{children:(0,a.jsxs)(m.A,{children:[(0,a.jsxs)(x.A,{className:"mb-6",children:[(0,a.jsx)(u.A,{children:"DAU/WAU/MAU"}),(0,a.jsx)(u.A,{children:"Per User Usage (Last 30 Days)"})]}),(0,a.jsxs)(h.A,{children:[(0,a.jsxs)(p.A,{children:[(0,a.jsxs)("div",{className:"mb-6",children:[(0,a.jsx)(_.A,{children:"DAU, WAU & MAU per Agent"}),(0,a.jsx)(ez.A,{children:"Active users across different time periods"})]}),(0,a.jsxs)(m.A,{children:[(0,a.jsxs)(x.A,{className:"mb-6",children:[(0,a.jsx)(u.A,{children:"DAU"}),(0,a.jsx)(u.A,{children:"WAU"}),(0,a.jsx)(u.A,{children:"MAU"})]}),(0,a.jsxs)(h.A,{children:[(0,a.jsxs)(p.A,{children:[(0,a.jsx)("div",{className:"mb-4",children:(0,a.jsx)(_.A,{className:"text-lg",children:"Daily Active Users - Last 7 Days"})}),M?(0,a.jsx)(e$,{isDateChanging:!1}):(0,a.jsx)(n.A,{data:ee,index:"date",categories:J.map(Z),valueFormatter:e=>ea(e),yAxisWidth:60,showLegend:!0,stack:!0})]}),(0,a.jsxs)(p.A,{children:[(0,a.jsx)("div",{className:"mb-4",children:(0,a.jsx)(_.A,{className:"text-lg",children:"Weekly Active Users - Last 7 Weeks"})}),U?(0,a.jsx)(e$,{isDateChanging:!1}):(0,a.jsx)(n.A,{data:es,index:"week",categories:X.map(Z),valueFormatter:e=>ea(e),yAxisWidth:60,showLegend:!0,stack:!0})]}),(0,a.jsxs)(p.A,{children:[(0,a.jsx)("div",{className:"mb-4",children:(0,a.jsx)(_.A,{className:"text-lg",children:"Monthly Active Users - Last 7 Months"})}),$?(0,a.jsx)(e$,{isDateChanging:!1}):(0,a.jsx)(n.A,{data:et,index:"month",categories:Q.map(Z),valueFormatter:e=>ea(e),yAxisWidth:60,showLegend:!0,stack:!0})]})]})]})]}),(0,a.jsx)(p.A,{children:(0,a.jsx)(eW,{accessToken:e,selectedTags:T,formatAbbreviatedNumber:ea})})]})]})})]})};var eG=t(34844);let eJ=({endpointData:e})=>{let{locale:s}=(0,q.o)(),t=e||{},l=w.useMemo(()=>Object.entries(t).map(([e,s])=>({endpoint:e,"metrics.successful_requests":s.metrics.successful_requests,"metrics.failed_requests":s.metrics.failed_requests,metrics:{successful_requests:s.metrics.successful_requests,failed_requests:s.metrics.failed_requests}})),[t]);return(0,a.jsxs)(B.Zp,{children:[(0,a.jsxs)("div",{className:"flex justify-between items-center",children:[(0,a.jsx)(B.hE,{children:"zh-CN"===s?"各端点成功/失败请求对比":"Success vs Failed Requests by Endpoint"}),(0,a.jsx)(H,{categories:["metrics.successful_requests","metrics.failed_requests"],colors:["green","red"]})]}),(0,a.jsx)(B.Es,{className:"mt-4",data:l,index:"endpoint",categories:["metrics.successful_requests","metrics.failed_requests"],colors:["green","red"],valueFormatter:e=>e.toLocaleString(),customTooltip:Y,showLegend:!1,stack:!0,yAxisWidth:60})]})};var eX=t(75262);let eQ=function({dailyData:e,endpointData:s}){let{locale:t}=(0,q.o)(),l=(0,w.useMemo)(()=>{var s;let a,l;return e?.results&&0!==e.results.length?(s=e.results,a=[],l=new Set,s.forEach(e=>{e.breakdown.endpoints&&Object.keys(e.breakdown.endpoints).forEach(e=>l.add(e))}),s.forEach(e=>{let s=new Date(e.date),r={date:"zh-CN"===t?`${s.getMonth()+1}月${s.getDate()}日`:s.toLocaleDateString("en-US",{month:"short",day:"numeric"})};l.forEach(s=>{let t=e.breakdown.endpoints?.[s];r[s]=t?.metrics.api_requests||0}),a.push(r)}),a.reverse()):[]},[e,t]),r=(0,w.useMemo)(()=>0===l.length?[]:Object.keys(l[0]).filter(e=>"date"!==e),[l]);return(0,a.jsxs)(c.A,{className:"mb-6",children:[(0,a.jsx)("div",{className:"flex items-center justify-between mb-4",children:(0,a.jsx)(_.A,{children:"zh-CN"===t?"端点用量趋势":"Endpoint Usage Trends"})}),(0,a.jsx)(eX.A,{className:"h-80",data:l,index:"date",categories:r,colors:["blue","cyan","indigo","violet","purple","fuchsia","pink","rose","red","orange"].slice(0,r.length),valueFormatter:e=>e.toLocaleString(),showLegend:!0,showGridLines:!0,yAxisWidth:60,connectNulls:!0,curveType:"natural"})]})};var e0=t(65308);let e1=({endpointData:e})=>{let{t:s}=(0,q.o)(),t=Object.entries(e).map(([e,s])=>{var t,a;return{key:e,endpoint:e,successful_requests:s.metrics.successful_requests,failed_requests:s.metrics.failed_requests,api_requests:s.metrics.api_requests,total_tokens:s.metrics.total_tokens,spend:s.metrics.spend,successRate:(t=s.metrics.successful_requests,0===(a=s.metrics.api_requests)?0:t/a*100)}}),l=(0,w.useMemo)(()=>[{title:s("usagePage.endpointUsage.endpoint"),dataIndex:"endpoint",key:"endpoint",render:e=>(0,a.jsx)("span",{className:"font-medium",children:e})},{title:s("usagePage.endpointUsage.successfulFailed"),key:"requests",render:(e,s)=>{let t=s.api_requests>0?s.successful_requests/s.api_requests*100:0,l=s.api_requests>0?s.failed_requests/s.api_requests*100:0,r={"0%":"#22c55e"};return t>0&&t<100&&(r[`${t}%`]="#22c55e",r[`${t+.01}%`]="#ef4444"),r["100%"]=l>0?"#ef4444":"#22c55e",(0,a.jsxs)("div",{className:"flex items-center space-x-3",children:[(0,a.jsx)("div",{className:"flex-1 relative",children:(0,a.jsx)(e0.A,{percent:t+l,size:"small",strokeColor:r,showInfo:!1})}),(0,a.jsxs)("div",{className:"flex items-center space-x-2 text-sm min-w-[100px]",children:[(0,a.jsx)("span",{className:"text-green-600 font-medium",children:s.successful_requests.toLocaleString()}),(0,a.jsx)("span",{className:"text-gray-400",children:"/"}),(0,a.jsx)("span",{className:"text-red-600 font-medium",children:s.failed_requests.toLocaleString()})]})]})}},{title:s("usagePage.endpointUsage.totalRequest"),dataIndex:"api_requests",key:"api_requests",render:e=>e.toLocaleString()},{title:s("usagePage.endpointUsage.successRate"),dataIndex:"successRate",key:"successRate",render:e=>{let s=e.toFixed(2);return(0,a.jsxs)("span",{className:e>=95?"text-green-600 font-medium":e>=80?"text-yellow-600 font-medium":"text-red-600 font-medium",children:[s,"%"]})}},{title:s("usagePage.endpointUsage.tokens"),dataIndex:"total_tokens",key:"total_tokens",render:e=>e.toLocaleString()},{title:s("usagePage.endpointUsage.spend"),dataIndex:"spend",key:"spend",render:e=>`\xa5${(0,$.HY)(e)}`}],[s]);return(0,a.jsx)(W.A,{columns:l,dataSource:t,pagination:!1})},e2=({userSpendData:e})=>{let s=(0,w.useMemo)(()=>{let s={};return e?.results&&e.results.forEach(e=>{Object.entries(e.breakdown.endpoints||{}).forEach(([e,t])=>{s[e]||(s[e]={metrics:{spend:0,prompt_tokens:0,completion_tokens:0,total_tokens:0,api_requests:0,successful_requests:0,failed_requests:0,cache_read_input_tokens:0,cache_creation_input_tokens:0},metadata:t.metadata||{},api_key_breakdown:{}}),s[e].metrics.spend+=t.metrics.spend,s[e].metrics.prompt_tokens+=t.metrics.prompt_tokens,s[e].metrics.completion_tokens+=t.metrics.completion_tokens,s[e].metrics.total_tokens+=t.metrics.total_tokens,s[e].metrics.api_requests+=t.metrics.api_requests,s[e].metrics.successful_requests+=t.metrics.successful_requests||0,s[e].metrics.failed_requests+=t.metrics.failed_requests||0,s[e].metrics.cache_read_input_tokens+=t.metrics.cache_read_input_tokens||0,s[e].metrics.cache_creation_input_tokens+=t.metrics.cache_creation_input_tokens||0})}),s},[e]);return(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsx)(e1,{endpointData:s}),(0,a.jsx)(eJ,{endpointData:s}),(0,a.jsx)(eQ,{dailyData:e,endpointData:s})]})};var e5=t(27873),e4=t(29057),e6=t(90314),e3=t(55445),e8=t(53672);function e9({topModels:e,topModelsLimit:s,setTopModelsLimit:t}){let[l,r]=(0,w.useState)("table"),{t:i}=(0,q.o)(),c=[{header:i("usagePage.topKeyView.model"),accessorKey:"key",cell:e=>e.getValue()||"-"},{header:"花费",accessorKey:"spend",cell:e=>{let s=e.getValue();return`\xa5${(0,$.HY)(s)}`}},{header:i("usagePage.successfulRequests"),accessorKey:"successful_requests",cell:e=>(0,a.jsx)("span",{className:"text-green-600",children:e.getValue()?.toLocaleString()||0})},{header:i("usagePage.failedRequests"),accessorKey:"failed_requests",cell:e=>(0,a.jsx)("span",{className:"text-red-600",children:e.getValue()?.toLocaleString()||0})},{header:i("usagePage.totalTokens"),accessorKey:"tokens",cell:e=>e.getValue()?.toLocaleString()||0}],o=e.slice(0,s);return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)("div",{className:"mb-4 flex justify-between items-center",children:[(0,a.jsx)(y.A,{options:[{label:"5",value:5},{label:"10",value:10},{label:"25",value:25},{label:"50",value:50}],value:s,onChange:e=>t(e)}),(0,a.jsxs)("div",{className:"flex space-x-2",children:[(0,a.jsx)("button",{onClick:()=>r("table"),className:`px-3 py-1 text-sm rounded-md ${"table"===l?"bg-blue-100 text-blue-700":"bg-gray-100 text-gray-700"}`,children:i("usagePage.topKeyView.tableView")}),(0,a.jsx)("button",{onClick:()=>r("chart"),className:`px-3 py-1 text-sm rounded-md ${"chart"===l?"bg-blue-100 text-blue-700":"bg-gray-100 text-gray-700"}`,children:i("图表视图")})]})]}),"chart"===l?(0,a.jsx)("div",{className:"relative max-h-[600px] overflow-y-auto",children:(0,a.jsx)(n.A,{className:"mt-4 cursor-pointer hover:opacity-90",style:{height:52*Math.min(o.length,s)},data:o,index:"key",categories:["spend"],colors:["cyan"],valueFormatter:e=>`\xa5${(0,$.HY)(e)}`,layout:"vertical",yAxisWidth:200,tickGap:5,showLegend:!1})}):(0,a.jsx)("div",{className:"border rounded-lg overflow-hidden max-h-[600px] overflow-y-auto",children:(0,a.jsx)(e8.b,{columns:c,data:o,renderSubComponent:()=>(0,a.jsx)(a.Fragment,{}),getRowCanExpand:()=>!1,isLoading:!1})})]})}let e7=({accessToken:e,entityType:s,entityId:t,entityList:l,dateValue:r})=>{let i,j,[f,y]=(0,w.useState)({results:[],metadata:{total_spend:0,total_api_requests:0,total_successful_requests:0,total_failed_requests:0,total_tokens:0}}),{teams:k}=(0,e5.A)(),{t:b}=(0,q.o)(),A=ee(f,"models",k||[]),v=ee(f,"api_keys",k||[]),[N,S]=(0,w.useState)([]),[P,T]=(0,w.useState)(5),[D,E]=(0,w.useState)(5),L=async()=>{if(!e||!r.from||!r.to)return;let t=new Date(r.from),a=new Date(r.to);if("tag"===s)y(await (0,C.tagDailyActivityCall)(e,t,a,1,N.length>0?N:null));else if("team"===s)y(await (0,C.teamDailyActivityCall)(e,t,a,1,N.length>0?N:null));else if("organization"===s)y(await (0,C.organizationDailyActivityCall)(e,t,a,1,N.length>0?N:null));else if("customer"===s)y(await (0,C.customerDailyActivityCall)(e,t,a,1,N.length>0?N:null));else if("agent"===s)y(await (0,C.agentDailyActivityCall)(e,t,a,1,N.length>0?N:null));else throw Error("Invalid entity type")};(0,w.useEffect)(()=>{L()},[e,r,t,N]);let M=()=>{let e={};return f.results.forEach(s=>{Object.entries(s.breakdown.providers||{}).forEach(([s,t])=>{e[s]||(e[s]={provider:s,spend:0,requests:0,successful_requests:0,failed_requests:0,tokens:0});try{e[s].spend+=t.metrics.spend,e[s].requests+=t.metrics.api_requests,e[s].successful_requests+=t.metrics.successful_requests,e[s].failed_requests+=t.metrics.failed_requests,e[s].tokens+=t.metrics.total_tokens}catch(e){console.error(`Error processing provider ${s}: ${e}`)}})}),Object.values(e).filter(e=>e.spend>0).sort((e,s)=>s.spend-e.spend)},O=(e,s)=>{if(l){let s=l.find(s=>s.value===e);if(s)return s.label}return s?.team_alias?s.team_alias:e},U=()=>{var e;let s={};return f.results.forEach(e=>{Object.entries(e.breakdown.entities||{}).forEach(([e,t])=>{s[e]||(s[e]={metrics:{spend:0,prompt_tokens:0,completion_tokens:0,total_tokens:0,api_requests:0,successful_requests:0,failed_requests:0,cache_read_input_tokens:0,cache_creation_input_tokens:0},metadata:{alias:O(e,t.metadata),id:e}}),s[e].metrics.spend+=t.metrics.spend,s[e].metrics.api_requests+=t.metrics.api_requests,s[e].metrics.successful_requests+=t.metrics.successful_requests,s[e].metrics.failed_requests+=t.metrics.failed_requests,s[e].metrics.total_tokens+=t.metrics.total_tokens})}),e=Object.values(s).sort((e,s)=>s.metrics.spend-e.metrics.spend),0===N.length?e:e.filter(e=>N.includes(e.metadata.id))},F=s.charAt(0).toUpperCase()+s.slice(1);return(0,a.jsxs)("div",{style:{width:"100%"},className:"relative",children:[(0,a.jsx)(eS,{dateValue:r,entityType:s,spendData:f,showFilters:null!==l&&l.length>0,filterLabel:`Filter by ${s}`,filterPlaceholder:`Select ${s} to filter...`,selectedFilters:N,onFiltersChange:S,filterOptions:(()=>{if(l)return l})()||void 0,teams:k||[]}),(0,a.jsxs)(m.A,{children:[(0,a.jsxs)(x.A,{variant:"solid",className:"mt-1",children:[(0,a.jsx)(u.A,{children:"Cost"}),(0,a.jsx)(u.A,{children:b("agent"===s?"usagePage.entityUsage.requestTokenConsumption":"usagePage.modelActivity")}),(0,a.jsx)(u.A,{children:b("usagePage.keyActivity")}),(0,a.jsx)(u.A,{children:b("usagePage.endpointActivity")})]}),(0,a.jsxs)(h.A,{children:[(0,a.jsx)(p.A,{children:(0,a.jsxs)(d.A,{numItems:2,className:"gap-2 w-full",children:[(0,a.jsx)(o.A,{numColSpan:2,children:(0,a.jsxs)(c.A,{children:[(0,a.jsxs)(_.A,{children:[F," ",b("usagePage.entityUsage.tagSpendOverview").replace("标签","").replace("Tag","")]}),(0,a.jsxs)(d.A,{numItems:5,className:"gap-4 mt-4",children:[(0,a.jsxs)(c.A,{children:[(0,a.jsx)(_.A,{children:b("usagePage.entityUsage.totalSpend")}),(0,a.jsxs)(g.A,{className:"text-2xl font-bold mt-2",children:["\xa5",(0,$.HY)(f.metadata.total_spend,2)]})]}),(0,a.jsxs)(c.A,{children:[(0,a.jsx)(_.A,{children:b("usagePage.totalRequests")}),(0,a.jsx)(g.A,{className:"text-2xl font-bold mt-2",children:f.metadata.total_api_requests.toLocaleString()})]}),(0,a.jsxs)(c.A,{children:[(0,a.jsx)(_.A,{children:b("usagePage.successfulRequests")}),(0,a.jsx)(g.A,{className:"text-2xl font-bold mt-2 text-green-600",children:f.metadata.total_successful_requests.toLocaleString()})]}),(0,a.jsxs)(c.A,{children:[(0,a.jsx)(_.A,{children:b("usagePage.failedRequests")}),(0,a.jsx)(g.A,{className:"text-2xl font-bold mt-2 text-red-600",children:f.metadata.total_failed_requests.toLocaleString()})]}),(0,a.jsxs)(c.A,{children:[(0,a.jsx)(_.A,{children:b("usagePage.totalTokens")}),(0,a.jsx)(g.A,{className:"text-2xl font-bold mt-2",children:f.metadata.total_tokens.toLocaleString()})]})]})]})}),(0,a.jsx)(o.A,{numColSpan:2,children:(0,a.jsxs)(c.A,{children:[(0,a.jsx)(_.A,{children:b("usagePage.dailySpend")}),(0,a.jsx)(n.A,{data:[...f.results].sort((e,s)=>new Date(e.date).getTime()-new Date(s.date).getTime()),index:"date",categories:["metrics.spend"],colors:["cyan"],valueFormatter:J,yAxisWidth:100,showLegend:!1,customTooltip:({payload:e,active:s})=>{if(!s||!e?.[0])return null;let t=e[0].payload,l=Object.keys(t.breakdown.entities||{}).length;return(0,a.jsxs)("div",{className:"bg-white p-4 shadow-lg rounded-lg border",children:[(0,a.jsx)("p",{className:"font-bold",children:t.date}),(0,a.jsxs)("p",{className:"text-cyan-500",children:["Total Spend: \xa5",(0,$.HY)(t.metrics.spend,2)]}),(0,a.jsxs)("p",{className:"text-gray-600",children:["Total Requests: ",t.metrics.api_requests]}),(0,a.jsxs)("p",{className:"text-gray-600",children:["Successful: ",t.metrics.successful_requests]}),(0,a.jsxs)("p",{className:"text-gray-600",children:["Failed: ",t.metrics.failed_requests]}),(0,a.jsxs)("p",{className:"text-gray-600",children:["Total Tokens: ",t.metrics.total_tokens]}),(0,a.jsxs)("p",{className:"text-gray-600",children:["Total ",F,"s: ",l]}),(0,a.jsxs)("div",{className:"mt-2 border-t pt-2",children:[(0,a.jsxs)("p",{className:"font-semibold",children:["Spend by ",F,":"]}),Object.entries(t.breakdown.entities||{}).sort(([,e],[,s])=>{let t=e.metrics.spend;return s.metrics.spend-t}).slice(0,5).map(([e,s])=>(0,a.jsxs)("p",{className:"text-sm text-gray-600",children:[O(e,s.metadata),": \xa5",(0,$.HY)(s.metrics.spend,2)]},e)),l>5&&(0,a.jsxs)("p",{className:"text-sm text-gray-500 italic",children:["...and ",l-5," more"]})]})]})}})]})}),(0,a.jsx)(o.A,{numColSpan:2,children:(0,a.jsx)(c.A,{children:(0,a.jsxs)("div",{className:"flex flex-col space-y-4",children:[(0,a.jsxs)("div",{className:"flex flex-col space-y-2",children:[(0,a.jsxs)(_.A,{children:["Spend Per ",F]}),(0,a.jsx)(ez.A,{className:"text-xs",children:"Showing Top 5 by Spend"}),(0,a.jsxs)("div",{className:"flex items-center text-sm text-gray-500",children:[(0,a.jsxs)("span",{children:["Get Started by Tracking cost per ",F," "]}),(0,a.jsx)("a",{href:"https://docs.litellm.ai/docs/proxy/enterprise#spend-tracking",className:"text-blue-500 hover:text-blue-700 ml-1",children:"here"})]})]}),(0,a.jsxs)(d.A,{numItems:2,className:"gap-6",children:[(0,a.jsx)(o.A,{numColSpan:1,children:(0,a.jsx)(n.A,{className:"mt-4 h-52",data:U().slice(0,5).map(e=>({...e,metadata:{...e.metadata,alias_display:e.metadata.alias&&e.metadata.alias.length>15?`${e.metadata.alias.slice(0,15)}...`:e.metadata.alias}})),index:"metadata.alias_display",categories:["metrics.spend"],colors:["cyan"],valueFormatter:J,layout:"vertical",showLegend:!1,yAxisWidth:150,customTooltip:({payload:e,active:s})=>{if(!s||!e?.[0])return null;let t=e[0].payload;return(0,a.jsxs)("div",{className:"bg-white p-4 shadow-lg rounded-lg border",children:[(0,a.jsx)("p",{className:"font-bold",children:t.metadata.alias}),(0,a.jsxs)("p",{className:"text-cyan-500",children:["Spend: \xa5",(0,$.HY)(t.metrics.spend,4)]}),(0,a.jsxs)("p",{className:"text-gray-600",children:["Requests: ",t.metrics.api_requests.toLocaleString()]}),(0,a.jsxs)("p",{className:"text-green-600",children:["Successful: ",t.metrics.successful_requests.toLocaleString()]}),(0,a.jsxs)("p",{className:"text-red-600",children:["Failed: ",t.metrics.failed_requests.toLocaleString()]}),(0,a.jsxs)("p",{className:"text-gray-600",children:["Tokens: ",t.metrics.total_tokens.toLocaleString()]})]})}})}),(0,a.jsx)(o.A,{numColSpan:1,children:(0,a.jsx)("div",{className:"h-52 overflow-y-auto",children:(0,a.jsxs)(eI.A,{children:[(0,a.jsx)(eY.A,{children:(0,a.jsxs)(eB.A,{children:[(0,a.jsx)(eH.A,{children:F}),(0,a.jsx)(eH.A,{children:"Spend"}),(0,a.jsx)(eH.A,{className:"text-green-600",children:"Successful"}),(0,a.jsx)(eH.A,{className:"text-red-600",children:"Failed"}),(0,a.jsx)(eH.A,{children:"Tokens"})]})}),(0,a.jsx)(eV.A,{children:U().filter(e=>e.metrics.spend>0).map(e=>(0,a.jsxs)(eB.A,{children:[(0,a.jsx)(eK.A,{children:e.metadata.alias}),(0,a.jsxs)(eK.A,{children:["\xa5",(0,$.HY)(e.metrics.spend,4)]}),(0,a.jsx)(eK.A,{className:"text-green-600",children:e.metrics.successful_requests.toLocaleString()}),(0,a.jsx)(eK.A,{className:"text-red-600",children:e.metrics.failed_requests.toLocaleString()}),(0,a.jsx)(eK.A,{children:e.metrics.total_tokens.toLocaleString()})]},e.metadata.id))})]})})})]})]})})}),(0,a.jsx)(o.A,{numColSpan:1,children:(0,a.jsxs)(c.A,{children:[(0,a.jsx)(_.A,{children:"Top Virtual Keys"}),(0,a.jsx)(e3.A,{topKeys:(console.log("debugTags",{spendData:f}),i={},f.results.forEach(e=>{let{breakdown:s}=e,{entities:t}=s;console.log("debugTags",{entities:t});let a=Object.keys(t).reduce((e,s)=>{let{api_key_breakdown:a}=t[s];return Object.keys(a).forEach(t=>{let l={tag:s,usage:a[t].metrics.spend};e[t]?e[t].push(l):e[t]=[l]}),e},{});console.log("debugTags",{tagDictionary:a}),Object.entries(e.breakdown.api_keys||{}).forEach(([e,s])=>{i[e]||(i[e]={metrics:{spend:0,prompt_tokens:0,completion_tokens:0,total_tokens:0,api_requests:0,successful_requests:0,failed_requests:0,cache_read_input_tokens:0,cache_creation_input_tokens:0},metadata:{key_alias:s.metadata.key_alias,team_id:s.metadata.team_id||null,tags:a[e]||[]}},console.log("debugTags",{keySpend:i})),i[e].metrics.spend+=s.metrics.spend,i[e].metrics.prompt_tokens+=s.metrics.prompt_tokens,i[e].metrics.completion_tokens+=s.metrics.completion_tokens,i[e].metrics.total_tokens+=s.metrics.total_tokens,i[e].metrics.api_requests+=s.metrics.api_requests,i[e].metrics.successful_requests+=s.metrics.successful_requests,i[e].metrics.failed_requests+=s.metrics.failed_requests,i[e].metrics.cache_read_input_tokens+=s.metrics.cache_read_input_tokens||0,i[e].metrics.cache_creation_input_tokens+=s.metrics.cache_creation_input_tokens||0})}),Object.entries(i).map(([e,s])=>({api_key:e,key_alias:s.metadata.key_alias||"-",tags:s.metadata.tags||"-",spend:s.metrics.spend})).sort((e,s)=>s.spend-e.spend).slice(0,P)),teams:null,showTags:"tag"===s,topKeysLimit:P,setTopKeysLimit:T})]})}),(0,a.jsx)(o.A,{numColSpan:1,children:(0,a.jsxs)(c.A,{children:[(0,a.jsx)(_.A,{children:b("agent"===s?"usagePage.entityUsage.topAgents":"usagePage.entityUsage.topModels")}),(0,a.jsx)(e9,{topModels:(j={},f.results.forEach(e=>{Object.entries(e.breakdown.models||{}).forEach(([e,s])=>{j[e]||(j[e]={spend:0,requests:0,successful_requests:0,failed_requests:0,tokens:0});try{j[e].spend+=s.metrics.spend}catch(t){console.error(`Error adding spend for ${e}: ${t}, got metrics: ${JSON.stringify(s)}`)}j[e].requests+=s.metrics.api_requests,j[e].successful_requests+=s.metrics.successful_requests,j[e].failed_requests+=s.metrics.failed_requests,j[e].tokens+=s.metrics.total_tokens})}),Object.entries(j).map(([e,s])=>({key:e,...s})).sort((e,s)=>s.spend-e.spend).slice(0,D)),topModelsLimit:D,setTopModelsLimit:E})]})}),(0,a.jsx)(o.A,{numColSpan:2,children:(0,a.jsx)(c.A,{children:(0,a.jsxs)("div",{className:"flex flex-col space-y-4",children:[(0,a.jsx)(_.A,{children:"Provider Usage"}),(0,a.jsxs)(d.A,{numItems:2,children:[(0,a.jsx)(o.A,{numColSpan:1,children:(0,a.jsx)(e4.A,{className:"mt-4 h-40",data:M(),index:"provider",category:"spend",valueFormatter:e=>`\xa5${(0,$.HY)(e)}`,colors:["cyan","blue","indigo","violet","purple"]})}),(0,a.jsx)(o.A,{numColSpan:1,children:(0,a.jsxs)(eI.A,{children:[(0,a.jsx)(eY.A,{children:(0,a.jsxs)(eB.A,{children:[(0,a.jsx)(eH.A,{children:"Provider"}),(0,a.jsx)(eH.A,{children:"Spend"}),(0,a.jsx)(eH.A,{className:"text-green-600",children:"Successful"}),(0,a.jsx)(eH.A,{className:"text-red-600",children:"Failed"}),(0,a.jsx)(eH.A,{children:"Tokens"})]})}),(0,a.jsx)(eV.A,{children:M().map(e=>(0,a.jsxs)(eB.A,{children:[(0,a.jsx)(eK.A,{children:(0,a.jsxs)("div",{className:"flex items-center space-x-2",children:[e.provider&&(0,a.jsx)("img",{src:(0,e6.li)(e.provider).logo,alt:`${e.provider} logo`,className:"w-4 h-4",onError:s=>{let t=s.target,a=t.parentElement;if(a){let s=document.createElement("div");s.className="w-4 h-4 rounded-full bg-gray-200 flex items-center justify-center text-xs",s.textContent=e.provider?.charAt(0)||"-",a.replaceChild(s,t)}}}),(0,a.jsx)("span",{children:e.provider})]})}),(0,a.jsxs)(eK.A,{children:["\xa5",(0,$.HY)(e.spend,2)]}),(0,a.jsx)(eK.A,{className:"text-green-600",children:e.successful_requests.toLocaleString()}),(0,a.jsx)(eK.A,{className:"text-red-600",children:e.failed_requests.toLocaleString()}),(0,a.jsx)(eK.A,{children:e.tokens.toLocaleString()})]},e.provider))})]})})]})]})})})]})}),(0,a.jsx)(p.A,{children:(0,a.jsx)(Q,{modelMetrics:A,hidePromptCachingMetrics:"agent"===s})}),(0,a.jsx)(p.A,{children:(0,a.jsx)(Q,{modelMetrics:v,hidePromptCachingMetrics:"agent"===s})}),(0,a.jsx)(p.A,{children:(0,a.jsx)(e2,{userSpendData:f})})]})]})]})};var se=t(6924),ss=t(94210),st=t(5533),sa=t(63301),sl=t(54550),sr=t(19910),si=t(78897),sn=t(64e3),sc=t(26313);let so=({value:e,onChange:s,isAdmin:t,title:l="Usage View",description:r="Select the usage data you want to view","data-id":i})=>{let{t:n}=(0,q.o)(),c=[{value:"global",label:n("usagePage.globalUsage"),showForAdmin:n("usagePage.globalUsageAdmin"),showForNonAdmin:n("usagePage.globalUsageNonAdmin"),description:n("usagePage.globalUsageDescAdmin"),descriptionForAdmin:n("usagePage.globalUsageDescAdmin"),descriptionForNonAdmin:n("usagePage.globalUsageDescNonAdmin"),icon:(0,a.jsx)(se.A,{style:{fontSize:"16px"}})},{value:"organization",label:n("usagePage.organizationUsage"),showForAdmin:n("usagePage.organizationUsageAdmin"),showForNonAdmin:n("usagePage.organizationUsageNonAdmin"),description:n("usagePage.organizationUsageDescAdmin"),descriptionForAdmin:n("usagePage.organizationUsageDescAdmin"),descriptionForNonAdmin:n("usagePage.organizationUsageDescNonAdmin"),icon:(0,a.jsx)(ss.A,{style:{fontSize:"16px"}})},{value:"team",label:n("usagePage.teamUsage"),description:n("usagePage.teamUsageDesc"),icon:(0,a.jsx)(st.A,{style:{fontSize:"16px"}})},{value:"customer",label:n("usagePage.customerUsage"),description:n("usagePage.customerUsageDesc"),icon:(0,a.jsx)(sa.A,{style:{fontSize:"16px"}}),adminOnly:!0},{value:"tag",label:n("usagePage.tagUsage"),description:n("usagePage.tagUsageDesc"),icon:(0,a.jsx)(sl.A,{style:{fontSize:"16px"}}),adminOnly:!0},{value:"agent",label:n("usagePage.agentUsage"),description:n("usagePage.agentUsageDesc"),icon:(0,a.jsx)(sr.A,{style:{fontSize:"16px"}}),adminOnly:!0},{value:"user-agent-activity",label:n("usagePage.userAgentActivity"),description:n("usagePage.userAgentActivityDesc"),icon:(0,a.jsx)(si.A,{style:{fontSize:"16px"}}),adminOnly:!0}].filter(e=>!e.adminOnly||!!t).map(e=>{let s=e.label,a=e.description;return e.showForAdmin&&e.showForNonAdmin&&(s=t?e.showForAdmin:e.showForNonAdmin),e.descriptionForAdmin&&e.descriptionForNonAdmin&&(a=t?e.descriptionForAdmin:e.descriptionForNonAdmin),{value:e.value,label:s,description:a,icon:e.icon,badgeText:e.badgeText}});return(0,a.jsx)("div",{className:"w-full","data-id":i,children:(0,a.jsxs)("div",{className:"flex flex-wrap items-center justify-start gap-4",children:[(0,a.jsxs)("div",{className:"flex items-stretch gap-2 min-w-0",children:[(0,a.jsx)("div",{className:"flex-shrink-0 flex items-center",children:(0,a.jsx)(sn.A,{style:{fontSize:"32px"}})}),(0,a.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,a.jsx)("h3",{className:"text-sm font-semibold text-gray-900 mb-0.5 leading-tight",children:n("usagePage.usageView")}),(0,a.jsx)("p",{className:"text-xs text-gray-600 leading-tight",children:n("usagePage.selectUsageView")})]})]}),(0,a.jsx)("div",{className:"flex-shrink-0",children:(0,a.jsx)(j.A,{value:e,onChange:s,className:"w-54 sm:w-64 md:w-72",size:"large",options:c.map(e=>({value:e.value,label:e.label})),optionRender:e=>{let s=c.find(s=>s.value===e.value);return s?(0,a.jsxs)("div",{className:"flex items-center gap-2 py-1",children:[(0,a.jsx)("div",{className:"flex-shrink-0 mt-0.5",children:s.icon}),(0,a.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,a.jsx)("div",{className:"text-sm font-medium text-gray-900",children:s.label}),(0,a.jsx)("div",{className:"text-xs text-gray-600 mt-0.5",children:s.description})]}),s.badgeText&&(0,a.jsx)("div",{className:"items-center",children:(0,a.jsx)(sc.A,{color:"blue",count:s.badgeText})})]}):e.label},labelRender:e=>{let s=c.find(s=>s.value===e.value);return s?(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)("div",{children:s.icon}),(0,a.jsx)("span",{className:"text-sm",children:s.label})]}):e.label}})})]})})};var sd=t(91808),su=t(76444);let{TextArea:sm}=sd.A,sx={get_usage_data:"\uD83D\uDCCA",get_team_usage_data:"\uD83D\uDC65",get_tag_usage_data:"\uD83C\uDFF7️"},sp=({step:e})=>{let s=sx[e.tool_name]||"\uD83D\uDD27",t=e.arguments,l=t.start_date&&t.end_date?`${t.start_date} → ${t.end_date}`:"",r=t.team_ids||t.tags||t.user_id||"";return(0,a.jsxs)("div",{className:"flex items-start gap-2 px-3 py-2 rounded-lg bg-gray-100 border border-gray-200 text-xs",children:[(0,a.jsx)("span",{className:"flex-shrink-0 mt-0.5",children:"running"===e.status?(0,a.jsx)(ei.A,{size:"small"}):"error"===e.status?(0,a.jsx)("span",{className:"text-red-500",children:"✗"}):(0,a.jsx)("span",{className:"text-green-600",children:"✓"})}),(0,a.jsxs)("div",{className:"min-w-0",children:[(0,a.jsxs)("div",{className:"font-medium text-gray-700",children:[s," ",e.tool_label]}),l&&(0,a.jsx)("div",{className:"text-gray-500 mt-0.5",children:l}),r&&(0,a.jsxs)("div",{className:"text-gray-500 mt-0.5",children:["Filter: ",r]}),"error"===e.status&&e.error&&(0,a.jsx)("div",{className:"text-red-600 mt-0.5",children:e.error})]})]})},sh=({content:e})=>(0,a.jsx)(su.oz,{components:{p:({children:e})=>(0,a.jsx)("p",{className:"mb-2 last:mb-0",children:e}),strong:({children:e})=>(0,a.jsx)("strong",{className:"font-semibold",children:e}),ul:({children:e})=>(0,a.jsx)("ul",{className:"list-disc pl-4 mb-2 space-y-0.5",children:e}),ol:({children:e})=>(0,a.jsx)("ol",{className:"list-decimal pl-4 mb-2 space-y-0.5",children:e}),li:({children:e})=>(0,a.jsx)("li",{children:e}),h1:({children:e})=>(0,a.jsx)("h4",{className:"font-semibold text-sm mt-2 mb-1",children:e}),h2:({children:e})=>(0,a.jsx)("h4",{className:"font-semibold text-sm mt-2 mb-1",children:e}),h3:({children:e})=>(0,a.jsx)("h4",{className:"font-semibold text-sm mt-2 mb-1",children:e}),code:({children:e,className:s})=>s?.includes("language-")?(0,a.jsx)("pre",{className:"bg-gray-100 rounded p-2 my-1 overflow-x-auto text-xs",children:(0,a.jsx)("code",{children:e})}):(0,a.jsx)("code",{className:"px-1 py-0.5 rounded bg-gray-100 text-xs font-mono",children:e}),table:({children:e})=>(0,a.jsx)("div",{className:"overflow-x-auto my-2",children:(0,a.jsx)("table",{className:"text-xs border-collapse w-full",children:e})}),th:({children:e})=>(0,a.jsx)("th",{className:"border border-gray-200 px-2 py-1 bg-gray-50 font-medium text-left",children:e}),td:({children:e})=>(0,a.jsx)("td",{className:"border border-gray-200 px-2 py-1",children:e})},children:e}),sg=({open:e,onClose:s,accessToken:t})=>{let{t:l}=(0,q.o)(),[r,i]=(0,w.useState)([]),[n,c]=(0,w.useState)(""),[o,d]=(0,w.useState)(!1),[u,m]=(0,w.useState)(void 0),[x,p]=(0,w.useState)([]),[h,g]=(0,w.useState)(!1),[_,f]=(0,w.useState)(""),[y,k]=(0,w.useState)(null),[b,A]=(0,w.useState)([]),v=(0,w.useRef)(null),N=(0,w.useRef)(null);(0,w.useEffect)(()=>{e&&0===x.length&&S()},[e]),(0,w.useEffect)(()=>{"function"==typeof v.current?.scrollIntoView&&v.current.scrollIntoView({behavior:"smooth"})},[r,_,b,y]);let S=async()=>{if(t){g(!0);try{let e=await (0,C.modelHubCall)(t);if(e?.data?.length>0){let s=e.data.map(e=>e.model_group).sort();p(s)}}catch(e){console.error("Failed to load models:",e)}finally{g(!1)}}},P=async()=>{if(!t||!n.trim()||o)return;let e=[...r,{role:"user",content:n.trim()}];i(e),c(""),d(!0),f(""),k(null),A([]);let s=new AbortController;N.current=s;let a="",l=[];try{await (0,C.usageAiChatStream)(t,e.slice(-20).map(e=>({role:e.role,content:e.content})),u||"",e=>{k(null),a+=e,f(a)},()=>{k(null),A([]),i(e=>[...e,{role:"assistant",content:a,toolCalls:l.length>0?[...l]:void 0}]),f("")},e=>{k(null),A([]),i(s=>[...s,{role:"assistant",content:`Error: ${e}`}]),f("")},e=>{k(e)},e=>{let s=l.findIndex(s=>s.tool_name===e.tool_name);s>=0?l[s]={...e}:l.push({...e}),A([...l])},s.signal)}catch(t){if(t?.name==="AbortError"||s.signal.aborted)return;let e=t?.message||"Failed to get response. Please try again.";i(s=>[...s,{role:"assistant",content:`Error: ${e}`}]),f("")}finally{d(!1),N.current=null}};return(0,a.jsxs)("div",{"data-testid":"usage-ai-chat-panel",className:`fixed top-0 right-0 h-full bg-white border-l border-gray-200 shadow-2xl z-50 flex flex-col transition-transform duration-300 ease-in-out ${e?"translate-x-0":"translate-x-full"}`,style:{width:420},children:[(0,a.jsxs)("div",{className:"px-5 pt-5 pb-3 border-b border-gray-100 flex-shrink-0",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between mb-1",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)("svg",{className:"w-5 h-5 text-blue-600",viewBox:"0 0 16 16",fill:"currentColor",children:(0,a.jsx)("path",{d:"M8 1l1.5 3.5L13 6l-3.5 1.5L8 11 6.5 7.5 3 6l3.5-1.5L8 1zm4 7l.75 1.75L14.5 10.5l-1.75.75L12 13l-.75-1.75L9.5 10.5l1.75-.75L12 8zM4 9l.75 1.75L6.5 11.5l-1.75.75L4 14l-.75-1.75L1.5 11.5l1.75-.75L4 9z"})}),(0,a.jsx)("h3",{className:"text-base font-semibold text-gray-900",children:l("usagePage.aiChatPanel.title")})]}),(0,a.jsx)("button",{onClick:()=>{N.current&&N.current.abort(),s()},className:"text-gray-400 hover:text-gray-600 transition-colors p-1 rounded-md hover:bg-gray-100",children:(0,a.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),(0,a.jsx)("p",{className:"text-xs text-gray-500",children:l("usagePage.aiChatPanel.subtitle")})]}),(0,a.jsx)("div",{className:"px-5 py-3 border-b border-gray-100 flex-shrink-0",children:(0,a.jsx)(j.A,{placeholder:l("usagePage.aiChatPanel.selectModel"),value:u,onChange:e=>m(e),loading:h,showSearch:!0,allowClear:!0,size:"small",className:"w-full",options:x.map(e=>({label:e,value:e})),filterOption:(e,s)=>(s?.label??"").toLowerCase().includes(e.toLowerCase())})}),(0,a.jsxs)("div",{className:"flex-1 overflow-y-auto p-4 space-y-3 bg-gray-50",children:[0===r.length&&!_&&!o&&(0,a.jsxs)("div",{className:"flex flex-col items-center justify-center h-full text-gray-400",children:[(0,a.jsx)("svg",{className:"w-8 h-8 mb-2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"})}),(0,a.jsx)("p",{className:"text-sm font-medium",children:l("usagePage.aiChatPanel.emptyState")}),(0,a.jsx)("p",{className:"text-xs mt-1",children:l("usagePage.aiChatPanel.askQuestionPlaceholder")})]}),r.map((e,s)=>(0,a.jsx)("div",{children:"user"===e.role?(0,a.jsx)("div",{className:"flex justify-end",children:(0,a.jsx)("div",{className:"max-w-[88%] rounded-xl px-3.5 py-2 text-sm leading-relaxed bg-blue-600 text-white",children:e.content})}):(0,a.jsxs)("div",{className:"space-y-2",children:[e.toolCalls&&e.toolCalls.length>0&&(0,a.jsx)("div",{className:"space-y-1.5",children:e.toolCalls.map((e,s)=>(0,a.jsx)(sp,{step:e},s))}),(0,a.jsx)("div",{className:"max-w-[95%] rounded-xl px-3.5 py-2.5 text-sm leading-relaxed bg-white border border-gray-200 text-gray-800",children:(0,a.jsx)(sh,{content:e.content})})]})},s)),o&&b.length>0&&(0,a.jsx)("div",{className:"space-y-1.5",children:b.map((e,s)=>(0,a.jsx)(sp,{step:e},s))}),o&&!_&&(0,a.jsxs)("div",{className:"flex items-center gap-2 px-3 py-2 text-xs text-gray-500",children:[(0,a.jsx)(ei.A,{size:"small"}),(0,a.jsx)("span",{className:"italic",children:y||"Thinking..."})]}),_&&(0,a.jsx)("div",{className:"max-w-[95%] rounded-xl px-3.5 py-2.5 text-sm leading-relaxed bg-white border border-gray-200 text-gray-800",children:(0,a.jsx)(sh,{content:_})}),(0,a.jsx)("div",{ref:v})]}),(0,a.jsxs)("div",{className:"px-4 py-3 border-t border-gray-200 bg-white flex-shrink-0",children:[(0,a.jsxs)("div",{className:"flex gap-2",children:[(0,a.jsx)(sm,{value:n,onChange:e=>c(e.target.value),onKeyDown:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),P())},placeholder:l("usagePage.aiChatPanel.askQuestion"),autoSize:{minRows:1,maxRows:3},className:"flex-1",disabled:o}),(0,a.jsx)(eu.Ay,{type:"primary",onClick:P,disabled:!n.trim()||o,loading:o,children:l("usagePage.aiChatPanel.send")})]}),(0,a.jsxs)("div",{className:"flex justify-between items-center mt-2",children:[(0,a.jsx)("button",{onClick:()=>{i([]),f(""),A([]),k(null)},className:"text-xs text-gray-400 hover:text-gray-600 transition-colors",disabled:0===r.length,children:l("usagePage.aiChatPanel.clearChat")}),(0,a.jsx)("span",{className:"text-xs text-gray-400",children:"Enter to send"})]})]})]})},s_=({teams:e,organizations:s})=>{let t,{accessToken:v,userRole:T,userId:z,premiumUser:I}=(0,E.A)(),{t:V}=(0,q.o)(),[K,Y]=(0,w.useState)({results:[],metadata:{}}),[H,B]=(0,w.useState)(!1),[W,Z]=(0,w.useState)(!1),G=(0,w.useMemo)(()=>N()().startOf("week").startOf("day").toDate(),[]),X=(0,w.useMemo)(()=>N()().endOf("week").endOf("day").toDate(),[]),[es,et]=(0,w.useState)({from:G,to:X}),[ea,el]=(0,w.useState)([]),{data:er=[]}=(()=>{let{accessToken:e,userRole:s}=(0,E.A)();return(0,P.I)({queryKey:L.list({}),queryFn:async()=>await (0,C.allEndUsersCall)(e),enabled:!!e&&D.CX.includes(s)})})(),{data:ei}=(0,S._)(),{data:en}=(0,M.i)(),eo=en?.max_budget??en?.litellm_budget_table?.max_budget??null;console.log(`currentUser: ${JSON.stringify(en)}`),console.log(`currentUser max budget: ${eo}`);let ed=D.CX.includes(T||""),[eu,em]=(0,w.useState)(""),[ex,ep]=(0,A.M)("",{wait:300}),{data:eh,fetchNextPage:eg,hasNextPage:e_,isFetchingNextPage:ej,isLoading:ef}=((e=F,s)=>{let{accessToken:t,userRole:a}=(0,E.A)();return(0,O.q)({queryKey:U.list({filters:{pageSize:e,...s&&{searchEmail:s}}}),queryFn:async({pageParam:a})=>await (0,C.userListCall)(t,null,a,e,s||null),initialPageParam:1,getNextPageParam:e=>{if(e.page<e.total_pages)return e.page+1},enabled:!!t&&D.CX.includes(a)})})(50,ex||void 0),ey=(0,w.useMemo)(()=>{if(!eh?.pages)return[];let e=new Set,s=[];for(let t of eh.pages)for(let a of t.users)e.has(a.user_id)||(e.add(a.user_id),s.push({value:a.user_id,label:a.user_alias?`${a.user_alias} (${a.user_id})`:a.user_email?`${a.user_email} (${a.user_id})`:a.user_id}));return s},[eh]),[ek,eb]=(0,w.useState)(ed?null:z||null),[eA,ev]=(0,w.useState)("groups"),[eN,eq]=(0,w.useState)(null),[eS,eC]=(0,w.useState)(!1),[eP,eT]=(0,w.useState)(!1),[eD,eE]=(0,w.useState)(!1),[eL,eM]=(0,w.useState)("global"),[eO,eF]=(0,w.useState)("week"),[eR,ez]=(0,w.useState)(!0),[eI,eV]=(0,w.useState)(5),[eK,eY]=(0,w.useState)(5),eH=e=>`${e.getFullYear()}年${e.getMonth()+1}月${e.getDate()}日`,eB=async()=>{v&&el(Object.values(await (0,C.tagListCall)(v)).map(e=>({label:e.name,value:e.name})))};(0,w.useEffect)(()=>{eB()},[v]),(0,w.useEffect)(()=>{!ed&&z&&eb(z)},[ed,z]),(0,w.useEffect)(()=>{(async()=>{if(!ed||!ek||!v||!T)return eq(null);try{let e=await (0,C.userInfoCall)(v,ek,T,!1,null,null,!0),s=e?.user_info??e,t=s?.max_budget??s?.litellm_budget_table?.max_budget??null;eq(t)}catch(e){console.error("Failed to fetch selected user budget:",e),eq(null)}})()},[ed,ek,v,T]);let eW=K.metadata?.total_spend||0,eJ=(0,w.useCallback)(async()=>{if(!v||!es.from||!es.to)return;let e=ed?ek:z||null;B(!0);let s=new Date(es.from),t=new Date(es.to);try{try{let a=await (0,C.userDailyActivityAggregatedCall)(v,s,t,e);Y(a);return}catch(e){}let a=await (0,C.userDailyActivityCall)(v,s,t,1,e);if(a.metadata.total_pages<=1)return void Y(a);let l=[...a.results],r={...a.metadata};for(let i=2;i<=a.metadata.total_pages;i++){let a=await (0,C.userDailyActivityCall)(v,s,t,i,e);l.push(...a.results),a.metadata&&(r.total_spend+=a.metadata.total_spend||0,r.total_api_requests+=a.metadata.total_api_requests||0,r.total_successful_requests+=a.metadata.total_successful_requests||0,r.total_failed_requests+=a.metadata.total_failed_requests||0,r.total_tokens+=a.metadata.total_tokens||0)}Y({results:l,metadata:r})}catch(e){console.error("Error fetching user spend data:",e)}finally{B(!1),Z(!1)}},[v,es.from,es.to,ek,ed,z]),eX=(0,w.useCallback)((e,s)=>{Z(!0),B(!0),et(e),s&&eF(s)},[]);(0,w.useEffect)(()=>{if(!es.from||!es.to)return;let e=setTimeout(()=>{eJ()},50);return()=>clearTimeout(e)},[eJ]);let eQ=ee(K,"models",e),e0=ee(K,"api_keys",e),e1=ee(K,"mcp_servers",e);return(0,a.jsxs)("div",{style:{width:"100%"},className:"p-8 md:p-10 relative bg-slate-50/40",children:[(0,a.jsxs)("div",{className:"mb-8",children:[(0,a.jsxs)("div",{className:"flex flex-wrap items-start justify-between gap-4 mb-5",children:[(0,a.jsx)("div",{className:"flex-1 min-w-[280px]",children:(0,a.jsx)(so,{value:eL,onChange:e=>eM(e),isAdmin:ed})}),(0,a.jsxs)("div",{className:"flex flex-wrap items-center justify-end gap-3 w-full xl:w-auto",children:[(0,a.jsx)(eU,{value:es,onValueChange:eX,className:"w-full sm:w-auto"}),"global"===eL&&(0,a.jsx)("div",{className:"flex items-center gap-2 ml-auto",children:(0,a.jsx)(R.$,{onClick:()=>eT(!0),className:"shadow-sm",icon:()=>(0,a.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"})}),children:"导出数据"})})]})]}),(0,a.jsxs)("div",{className:"flex-1",children:["global"===eL&&(0,a.jsx)(a.Fragment,{children:(0,a.jsxs)(m.A,{children:[(0,a.jsx)("div",{className:"flex justify-between items-center",children:(0,a.jsxs)(x.A,{variant:"solid",className:"mt-1 bg-gray-100/90 rounded-xl p-1 shadow-inner",children:[(0,a.jsx)(u.A,{children:"花费"}),(0,a.jsx)(u.A,{children:V("usagePage.modelActivity")}),(0,a.jsx)(u.A,{children:V("usagePage.keyActivity")}),(0,a.jsx)(u.A,{children:"MCP 服务器活动"}),(0,a.jsx)(u.A,{children:V("usagePage.endpointActivity")})]})}),(0,a.jsxs)(h.A,{children:[(0,a.jsx)(p.A,{children:(0,a.jsxs)(d.A,{numItems:2,className:"gap-6 w-full",children:[(0,a.jsxs)(o.A,{numColSpan:2,children:[(0,a.jsxs)("div",{className:"flex items-center gap-4 mt-2 mb-3 rounded-2xl border border-gray-200/80 bg-white px-5 py-4 shadow-sm",children:[(0,a.jsxs)(g.A,{className:"text-slate-600 text-[16px] md:text-[18px] font-semibold tracking-tight",children:["时间范围"," ",es.from&&es.to&&(0,a.jsxs)(a.Fragment,{children:[eH(es.from)," - ",eH(es.to)]})]}),ed&&(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)(l.A,{style:{fontSize:"14px",color:"#6b7280"}}),(0,a.jsx)(j.A,{showSearch:!0,allowClear:!0,style:{width:300},placeholder:V("usagePage.allUsersPlaceholder"),value:ek,onChange:e=>eb(e??null),filterOption:!1,onSearch:e=>{em(e),ep(e)},searchValue:eu,onPopupScroll:e=>{let s=e.currentTarget;(s.scrollTop+s.clientHeight)/s.scrollHeight>=.8&&e_&&!ej&&eg()},loading:ef,notFoundContent:ef?(0,a.jsx)(r.A,{spin:!0}):V("usagePage.noUsersFound"),options:ey,popupRender:e=>(0,a.jsxs)(a.Fragment,{children:[e,ej&&(0,a.jsx)("div",{style:{textAlign:"center",padding:8},children:(0,a.jsx)(r.A,{spin:!0})})]})}),ek&&(0,a.jsx)("span",{className:"text-xs text-gray-500",children:V("usagePage.filteringByUser")})]})]}),(0,a.jsx)(eG.A,{userSpend:eW,selectedTeam:null,userMaxBudget:ed&&ek?eN:eo})]}),(0,a.jsx)(o.A,{numColSpan:2,children:(0,a.jsxs)(c.A,{className:"rounded-2xl border border-slate-200/80 shadow-sm bg-white",children:[(0,a.jsx)(_.A,{className:"text-slate-800 text-[16px] md:text-[18px] tracking-tight",children:V("usagePage.usageMetrics")}),(0,a.jsxs)(d.A,{numItems:5,className:"gap-5 mt-5",children:[(0,a.jsxs)(c.A,{className:"rounded-2xl border border-slate-200/80 shadow-sm bg-slate-50/60",children:[(0,a.jsx)(_.A,{className:"text-slate-700 text-sm",children:V("usagePage.totalRequests")}),(0,a.jsx)(g.A,{className:"text-[24px] md:text-[26px] font-semibold mt-2 text-slate-700 leading-tight",children:K.metadata?.total_api_requests?.toLocaleString()||0})]}),(0,a.jsxs)(c.A,{className:"rounded-2xl border border-slate-200/80 shadow-sm bg-slate-50/60",children:[(0,a.jsx)(_.A,{className:"text-slate-700 text-sm",children:V("usagePage.successfulRequests")}),(0,a.jsx)(g.A,{className:"text-[24px] md:text-[26px] font-semibold mt-2 text-emerald-600 leading-tight",children:K.metadata?.total_successful_requests?.toLocaleString()||0})]}),(0,a.jsxs)(c.A,{className:"rounded-2xl border border-slate-200/80 shadow-sm bg-slate-50/60",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)(_.A,{className:"text-slate-700 text-sm",children:V("usagePage.failedRequests")}),(0,a.jsx)(f.A,{title:V("usagePage.failedRequestsTooltip"),children:(0,a.jsx)(i.A,{className:"text-gray-400 hover:text-gray-600"})})]}),(0,a.jsx)(g.A,{className:"text-[24px] md:text-[26px] font-semibold mt-2 text-rose-600 leading-tight",children:K.metadata?.total_failed_requests?.toLocaleString()||0})]}),(0,a.jsxs)(c.A,{className:"rounded-2xl border border-slate-200/80 shadow-sm bg-slate-50/60",children:[(0,a.jsx)(_.A,{className:"text-slate-700 text-sm",children:V("usagePage.totalTokens")}),(0,a.jsx)(g.A,{className:"text-[24px] md:text-[26px] font-semibold mt-2 text-slate-600 leading-tight",children:K.metadata?.total_tokens?.toLocaleString()||0})]}),(0,a.jsxs)(c.A,{className:"rounded-2xl border border-slate-200/80 shadow-sm bg-slate-50/60",children:[(0,a.jsx)(_.A,{className:"text-slate-700 text-sm",children:V("usagePage.averageCostPerRequest")}),(0,a.jsxs)(g.A,{className:"text-[24px] md:text-[26px] font-semibold mt-2 text-slate-600 leading-tight",children:["\xa5",(0,$.HY)((eW||0)/(K.metadata?.total_api_requests||1),4)]})]})]})]})}),(0,a.jsx)(o.A,{numColSpan:2,children:(0,a.jsxs)(c.A,{className:"rounded-2xl border border-slate-200/80 shadow-sm bg-white",children:[(0,a.jsx)(_.A,{className:"text-slate-800 text-[16px] md:text-[18px] tracking-tight",children:V("usagePage.dailySpend")}),H?(0,a.jsx)(e$,{isDateChanging:W}):(0,a.jsx)(n.A,{data:[...K.results].sort((e,s)=>new Date(e.date).getTime()-new Date(s.date).getTime()),index:"date",categories:["metrics.spend"],colors:["cyan"],valueFormatter:J,yAxisWidth:100,showLegend:!1,customTooltip:({payload:e,active:s})=>{if(!s||!e?.[0])return null;let t=e[0].payload;return(0,a.jsxs)("div",{className:"bg-white p-4 shadow-lg rounded-lg border",children:[(0,a.jsx)("p",{className:"font-bold",children:t.date}),(0,a.jsxs)("p",{className:"text-cyan-500",children:[V("usagePage.spend"),": \xa5",(0,$.HY)(t.metrics.spend,2)]}),(0,a.jsxs)("p",{className:"text-gray-600",children:[V("usagePage.requests"),": ",t.metrics.api_requests]}),(0,a.jsxs)("p",{className:"text-gray-600",children:[V("usagePage.successful"),": ",t.metrics.successful_requests]}),(0,a.jsxs)("p",{className:"text-gray-600",children:[V("usagePage.failed"),": ",t.metrics.failed_requests]}),(0,a.jsxs)("p",{className:"text-gray-600",children:[V("usagePage.tokens"),": ",t.metrics.total_tokens]})]})}})]})}),(0,a.jsx)(o.A,{numColSpan:1,children:(0,a.jsxs)(c.A,{className:"h-full",children:[(0,a.jsx)(_.A,{children:V("usagePage.topVirtualKeys")}),(0,a.jsx)(e3.A,{topKeys:((e=5)=>{let s={};return K.results.forEach(e=>{Object.entries(e.breakdown.api_keys||{}).forEach(([e,t])=>{s[e]||(s[e]={metrics:{spend:0,prompt_tokens:0,completion_tokens:0,total_tokens:0,api_requests:0,successful_requests:0,failed_requests:0,cache_read_input_tokens:0,cache_creation_input_tokens:0},metadata:{key_alias:t.metadata.key_alias,team_id:null,tags:t.metadata.tags||[]}}),s[e].metrics.spend+=t.metrics.spend,s[e].metrics.prompt_tokens+=t.metrics.prompt_tokens,s[e].metrics.completion_tokens+=t.metrics.completion_tokens,s[e].metrics.total_tokens+=t.metrics.total_tokens,s[e].metrics.api_requests+=t.metrics.api_requests,s[e].metrics.successful_requests+=t.metrics.successful_requests,s[e].metrics.failed_requests+=t.metrics.failed_requests,s[e].metrics.cache_read_input_tokens+=t.metrics.cache_read_input_tokens||0,s[e].metrics.cache_creation_input_tokens+=t.metrics.cache_creation_input_tokens||0})}),console.log("debugTags",{keySpend:s,userSpendData:K}),Object.entries(s).map(([e,s])=>({api_key:e,key_alias:s.metadata.key_alias||"-",tags:s.metadata.tags||[],spend:s.metrics.spend})).sort((e,s)=>s.spend-e.spend).slice(0,e)})(eI),teams:null,topKeysLimit:eI,setTopKeysLimit:eV})]})}),(0,a.jsx)(o.A,{numColSpan:1,children:(0,a.jsxs)(c.A,{className:"h-full",children:[(0,a.jsx)(_.A,{children:"groups"===eA?V("usagePage.topPublicModelNames"):V("usagePage.topLitellmModels")}),(0,a.jsxs)("div",{className:"flex justify-between items-center mb-4",children:[(0,a.jsx)(y.A,{options:[{label:"5",value:5},{label:"10",value:10},{label:"25",value:25},{label:"50",value:50}],value:eK,onChange:e=>eY(e)}),(0,a.jsxs)("div",{className:"flex bg-gray-100 rounded-lg p-1",children:[(0,a.jsx)("button",{className:`px-3 py-1 text-sm rounded-md transition-colors ${"groups"===eA?"bg-white shadow-sm text-gray-900":"text-gray-600 hover:text-gray-900"}`,onClick:()=>ev("groups"),children:V("usagePage.publicModelName")}),(0,a.jsx)("button",{className:`px-3 py-1 text-sm rounded-md transition-colors ${"individual"===eA?"bg-white shadow-sm text-gray-900":"text-gray-600 hover:text-gray-900"}`,onClick:()=>ev("individual"),children:V("usagePage.litellmModelName")})]})]}),H?(0,a.jsx)(e$,{isDateChanging:W}):(0,a.jsx)("div",{className:"relative max-h-[600px] overflow-y-auto",children:(t="groups"===eA?((e=5)=>{let s={};return K.results.forEach(e=>{Object.entries(e.breakdown.model_groups||{}).forEach(([e,t])=>{s[e]||(s[e]={metrics:{spend:0,prompt_tokens:0,completion_tokens:0,total_tokens:0,api_requests:0,successful_requests:0,failed_requests:0,cache_read_input_tokens:0,cache_creation_input_tokens:0},metadata:{},api_key_breakdown:{}}),s[e].metrics.spend+=t.metrics.spend,s[e].metrics.prompt_tokens+=t.metrics.prompt_tokens,s[e].metrics.completion_tokens+=t.metrics.completion_tokens,s[e].metrics.total_tokens+=t.metrics.total_tokens,s[e].metrics.api_requests+=t.metrics.api_requests,s[e].metrics.successful_requests+=t.metrics.successful_requests||0,s[e].metrics.failed_requests+=t.metrics.failed_requests||0,s[e].metrics.cache_read_input_tokens+=t.metrics.cache_read_input_tokens||0,s[e].metrics.cache_creation_input_tokens+=t.metrics.cache_creation_input_tokens||0})}),Object.entries(s).map(([e,s])=>({key:e,spend:s.metrics.spend,requests:s.metrics.api_requests,successful_requests:s.metrics.successful_requests,failed_requests:s.metrics.failed_requests,tokens:s.metrics.total_tokens})).sort((e,s)=>s.spend-e.spend).slice(0,e)})(eK):((e=5)=>{let s={};return K.results.forEach(e=>{Object.entries(e.breakdown.models||{}).forEach(([e,t])=>{s[e]||(s[e]={metrics:{spend:0,prompt_tokens:0,completion_tokens:0,total_tokens:0,api_requests:0,successful_requests:0,failed_requests:0,cache_read_input_tokens:0,cache_creation_input_tokens:0},metadata:{},api_key_breakdown:{}}),s[e].metrics.spend+=t.metrics.spend,s[e].metrics.prompt_tokens+=t.metrics.prompt_tokens,s[e].metrics.completion_tokens+=t.metrics.completion_tokens,s[e].metrics.total_tokens+=t.metrics.total_tokens,s[e].metrics.api_requests+=t.metrics.api_requests,s[e].metrics.successful_requests+=t.metrics.successful_requests||0,s[e].metrics.failed_requests+=t.metrics.failed_requests||0,s[e].metrics.cache_read_input_tokens+=t.metrics.cache_read_input_tokens||0,s[e].metrics.cache_creation_input_tokens+=t.metrics.cache_creation_input_tokens||0})}),Object.entries(s).map(([e,s])=>({key:e,spend:s.metrics.spend,requests:s.metrics.api_requests,successful_requests:s.metrics.successful_requests,failed_requests:s.metrics.failed_requests,tokens:s.metrics.total_tokens})).sort((e,s)=>s.spend-e.spend).slice(0,e)})(eK),(0,a.jsx)(n.A,{className:"mt-4",style:{height:52*Math.min(t.length,eK)},data:t,index:"key",categories:["spend"],colors:["cyan"],valueFormatter:J,layout:"vertical",yAxisWidth:200,showLegend:!1,customTooltip:({payload:e,active:s})=>{if(!s||!e?.[0])return null;let t=e[0].payload;return(0,a.jsxs)("div",{className:"bg-white p-4 shadow-lg rounded-lg border",children:[(0,a.jsx)("p",{className:"font-bold",children:t.key}),(0,a.jsxs)("p",{className:"text-cyan-500",children:[V("usagePage.spend"),": \xa5",(0,$.HY)(t.spend,2)]}),(0,a.jsxs)("p",{className:"text-gray-600",children:[V("usagePage.totalRequests"),": ",t.requests.toLocaleString()]}),(0,a.jsxs)("p",{className:"text-green-600",children:[V("usagePage.successful"),": ",t.successful_requests.toLocaleString()]}),(0,a.jsxs)("p",{className:"text-red-600",children:[V("usagePage.failed"),": ",t.failed_requests.toLocaleString()]}),(0,a.jsxs)("p",{className:"text-gray-600",children:[V("usagePage.tokens"),": ",t.tokens.toLocaleString()]})]})}}))})]})})]})}),(0,a.jsx)(p.A,{children:(0,a.jsx)(Q,{modelMetrics:eQ})}),(0,a.jsx)(p.A,{children:(0,a.jsx)(Q,{modelMetrics:e0})}),(0,a.jsx)(p.A,{children:(0,a.jsx)(Q,{modelMetrics:e1})}),(0,a.jsx)(p.A,{children:(0,a.jsx)(e2,{userSpendData:K})})]})]})}),"organization"===eL&&(0,a.jsx)(e7,{accessToken:v,entityType:"organization",userID:z,userRole:T,dateValue:es,entityList:s?.map(e=>({label:e.organization_alias,value:e.organization_id}))||null,premiumUser:I}),"team"===eL&&(0,a.jsx)(e7,{accessToken:v,entityType:"team",userID:z,userRole:T,entityList:e?.map(e=>({label:e.team_alias,value:e.team_id}))||null,premiumUser:I,dateValue:es}),"customer"===eL&&(0,a.jsx)(e7,{accessToken:v,entityType:"customer",userID:z,userRole:T,entityList:er?.map(e=>({label:e.alias||e.user_id,value:e.user_id}))||null,premiumUser:I,dateValue:es}),"tag"===eL&&(0,a.jsxs)(a.Fragment,{children:[eR&&(0,a.jsx)(k.A,{banner:!0,type:"info",message:V("usagePage.reusableCredentialsTracked"),description:(0,a.jsx)(b.A.Text,{children:V("usagePage.reusableCredentialsDescription")}),closable:!0,onClose:()=>ez(!1),className:"mb-5"}),(0,a.jsx)(e7,{accessToken:v,entityType:"tag",userID:z,userRole:T,entityList:ea,premiumUser:I,dateValue:es})]}),"agent"===eL&&(0,a.jsx)(e7,{accessToken:v,entityType:"agent",userID:z,userRole:T,entityList:ei?.agents?.map(e=>({label:e.agent_name,value:e.agent_id}))||null,premiumUser:I,dateValue:es}),"user-agent-activity"===eL&&(0,a.jsx)(eZ,{accessToken:v,userRole:T,dateValue:es})]})]}),(0,a.jsx)(ec,{isOpen:eS,onClose:()=>eC(!1),accessToken:v}),(0,a.jsx)(ew,{isOpen:eP,onClose:()=>eT(!1),entityType:"team",spendData:{results:K.results,metadata:K.metadata},dateRange:es,timeRangeType:eO,selectedFilters:[],customTitle:V("usagePage.exportUsageData")}),(0,a.jsx)(sg,{open:eD,onClose:()=>eE(!1),accessToken:v})]})}},95480:(e,s,t)=>{t.d(s,{S:()=>i});var a=t(95155),l=t(12115),r=t(87287);function i({className:e="",...s}){var t,i;let n=(0,l.useId)();return t=()=>{let e=document.getAnimations().filter(e=>e instanceof CSSAnimation&&"spin"===e.animationName),s=e.find(e=>e.effect.target?.getAttribute("data-spinner-id")===n),t=e.find(e=>e.effect instanceof KeyframeEffect&&e.effect.target?.getAttribute("data-spinner-id")!==n);s&&t&&(s.currentTime=t.currentTime)},i=[n],(0,l.useLayoutEffect)(t,i),(0,a.jsxs)("svg",{"data-spinner-id":n,className:(0,r.cx)("pointer-events-none size-12 animate-spin text-current",e),fill:"none",viewBox:"0 0 24 24",...s,children:[(0,a.jsx)("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),(0,a.jsx)("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]})}}}]);